<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anatomy Pro - å®Œæ•´æœ€çµ‚ç‰ˆ</title>
    <style>
        :root { 
            --muscle: #e67e22; 
            --nerve: #f1c40f; 
            --vessel: #e74c3c; 
            --other: #95a5a6; 
            --main: #2c3e50; 
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f4f7f6; display: flex; }

        /* å´é‚Šæ¬„ */
        nav { 
            width: 250px; background: var(--main); color: white; 
            height: 100vh; padding: 20px; position: fixed; left: 0; top: 0;
            display: flex; flex-direction: column; box-sizing: border-box;
        }
        nav h2 { border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; }
        nav ul { list-style: none; padding: 0; flex-grow: 1; overflow-y: auto; }
        nav li { 
            padding: 12px; cursor: pointer; border-radius: 4px; 
            transition: 0.3s; font-size: 0.9rem; 
        }
        nav li:hover { background: #34495e; }
        nav li.active-region { background: #1abc9c; }
        .user-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: auto; text-align: center; }

        /* å³å´ä¸»ç•«é¢ */
        main { margin-left: 250px; flex-grow: 1; min-height: 100vh; display: flex; flex-direction: column; }

        /* é ‚éƒ¨ç¯©é¸ */
        .top-filter {
            position: sticky; top: 0; z-index: 100;
            background: white; padding: 15px 30px;
            display: flex; gap: 15px; flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .filter-btn {
            padding: 8px 20px; border: 1px solid #ddd; border-radius: 20px;
            cursor: pointer; background: white; font-weight: bold; transition: 0.3s;
        }
        .filter-btn.active { background: var(--main); color: white; border-color: var(--main); }

        /* å››æ¬„ä½ˆå±€ */
        .container { padding: 30px; }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 20px;
        }
        @media (max-width: 1400px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .card-grid { grid-template-columns: 1fr; } }

        /* å¡ç‰‡è¨­è¨ˆ */
        .card-container { perspective: 1000px; min-height: 180px; }
        .card { 
            width: 100%; height: 100%; min-height: 180px;
            transition: transform 0.6s; transform-style: preserve-3d; 
            cursor: pointer; position: relative; 
        }
        .card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; min-height: 180px;
            backface-visibility: hidden; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px; box-sizing: border-box; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;
        }
        .card-front { background: white; border-bottom: 5px solid var(--main); }
        .card-back { background: var(--main); color: white; transform: rotateY(180deg); }
        .card-front h3, .card-back h3 { 
            margin: 10px 0; padding: 0 10px;
            word-break: break-word; overflow-wrap: break-word;
            font-size: clamp(0.85rem, 1.5vw, 1.1rem);
        }
        .badge { 
            position: absolute; top: 10px; right: 10px; font-size: 0.7rem; 
            color: white; padding: 2px 8px; border-radius: 5px; 
        }

        /* Loading */
        .loading-state {
            grid-column: 1/-1; text-align: center; padding: 100px; color: #95a5a6;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd;
            border-top-color: var(--main); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ç©ºç™½ç‹€æ…‹ */
        .empty-state {
            grid-column: 1/-1; text-align: center; padding: 80px; color: #95a5a6;
        }

        /* å½ˆçª— */
        .modal { 
            display: none; position: fixed; z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
        }
        .modal-content { 
            background: white; margin: 5% auto; padding: 25px; 
            width: 90%; max-width: 450px; border-radius: 15px; 
            position: relative;
        }
        .comment-item { 
            background: #f0f2f5; padding: 10px; border-radius: 8px; 
            margin-bottom: 10px; font-size: 0.9rem; text-align: left;
            display: flex; justify-content: space-between; align-items: flex-start;
            gap: 10px;
        }
        .comment-item .comment-text { flex: 1; }
        .comment-item .delete-btn {
            background: none; border: none; cursor: pointer;
            color: #e74c3c; font-size: 0.8rem; padding: 0; flex-shrink: 0;
        }
        .comment-item .delete-btn:hover { text-decoration: underline; }

        /* Toast é€šçŸ¥ */
        .toast {
            position: fixed; bottom: 30px; right: 30px; z-index: 9999;
            background: #2c3e50; color: white; padding: 12px 20px;
            border-radius: 8px; font-size: 0.9rem;
            transform: translateY(100px); opacity: 0;
            transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: #e74c3c; }
        .toast.success { background: #27ae60; }
    </style>
</head>
<body>

<nav>
    <h2>ğŸ“ è§£å‰–éƒ¨ä½</h2>
    <ul id="region-list">
        <li data-region="1">1. èƒŒéƒ¨èˆ‡é ¸å¾Œå€</li>
        <li data-region="2">2. èƒ¸éƒ¨èˆ‡è…‹çª©å€</li>
        <li data-region="3">3. è‚©èƒ›ã€è‡‚éƒ¨èˆ‡è‚˜å€</li>
        <li data-region="4">4. å‰è‡‚å€</li>
        <li data-region="5">5. æ‰‹éƒ¨</li>
    </ul>
    <div class="user-box" id="user-info">
        <p>æª¢æŸ¥ç‹€æ…‹ä¸­...</p>
    </div>
</nav>

<main>
    <div class="top-filter">
        <button class="filter-btn active" data-cat="å…¨éƒ¨">å…¨éƒ¨</button>
        <button class="filter-btn" data-cat="Muscles">è‚Œè‚‰</button>
        <button class="filter-btn" data-cat="Nerves">ç¥ç¶“</button>
        <button class="filter-btn" data-cat="Vessel">è¡€ç®¡</button>
        <button class="filter-btn" data-cat="Other">å…¶ä»–</button>
    </div>

    <div class="container">
        <div id="card-grid" class="card-grid">
            <div class="loading-state">
                <h2>ğŸ”’ å·²é–å®šå…§å®¹</h2>
                <p>è«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
            </div>
        </div>
    </div>
</main>

<!-- ç•™è¨€å½ˆçª— -->
<div id="commentModal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <div id="comments-list" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="comment-input" placeholder="æ–°å¢ç­†è¨˜..." 
                style="flex:1; padding:10px; border:1px solid #ddd; border-radius:5px; outline:none;">
            <button id="send-btn" 
                style="padding:10px 20px; background:var(--main); color:white; border:none; border-radius:5px; cursor:pointer;">
                é€å‡º
            </button>
        </div>
        <button id="close-modal-btn"
            style="width:100%; margin-top:15px; padding:10px; border:none; background:#eee; cursor:pointer; border-radius:5px;">
            é—œé–‰
        </button>
    </div>
</div>

<!-- Toast é€šçŸ¥ -->
<div id="toast" class="toast"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { 
        getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDE09qO7g3wZT3MCKo3eV7jqrDg5TNPfRw",
        authDomain: "anatomy-dc089.firebaseapp.com",
        projectId: "anatomy-dc089",
        storageBucket: "anatomy-dc089.firebasestorage.app",
        messagingSenderId: "742909907454",
        appId: "1:742909907454:web:5afaaf70fc1b41247270af"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    const provider = new GoogleAuthProvider();

    let allData = [];
    let currentFilter = 'å…¨éƒ¨';
    let currentRegion = null;  // null = å…¨éƒ¨åœ°å€
    let currentUser = null;
    let activeCardId = null;

    // â”€â”€ Toast é€šçŸ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showToast(msg, type = '') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = `toast ${type} show`;
        setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    // â”€â”€ ç™»å…¥ç‹€æ…‹ç›£è½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    onAuthStateChanged(auth, (user) => {
        const userInfoBox = document.getElementById('user-info');
        if (user) {
            currentUser = user;
            userInfoBox.innerHTML = `
                <img src="${user.photoURL}" style="width:35px; border-radius:50%; border:2px solid white;"><br>
                <small>${user.displayName}</small><br>
                <button id="logout-btn" style="margin-top:5px; cursor:pointer; padding:2px 8px; border-radius:4px;">ç™»å‡º</button>
            `;
            document.getElementById('logout-btn').onclick = () => signOut(auth);
            loadData();
        } else {
            currentUser = null;
            userInfoBox.innerHTML = `
                <button id="login-btn" style="width:100%; padding:10px; cursor:pointer; border-radius:5px;">
                    ğŸ”‘ Google ç™»å…¥
                </button>
            `;
            document.getElementById('login-btn').onclick = () => {
                signInWithPopup(auth, provider).catch(() => {
                    showToast('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase Authentication å·²å•Ÿç”¨ Google æä¾›è€…ï¼', 'error');
                });
            };
            document.getElementById('card-grid').innerHTML = `
                <div class="loading-state">
                    <h2>ğŸ”’ å·²é–å®šå…§å®¹</h2>
                    <p>è«‹é»æ“Šå·¦å´æŒ‰éˆ•ç™»å…¥</p>
                </div>`;
        }
    });

    // â”€â”€ è¼‰å…¥è³‡æ–™ï¼ˆå« Modal åŒæ­¥ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadData() {
        document.getElementById('card-grid').innerHTML = `
            <div class="loading-state">
                <div class="spinner"></div>
                <p>è¼‰å…¥ä¸­...</p>
            </div>`;

        onSnapshot(collection(db, "flashcards"), (snap) => {
            allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            render();
            // è‹¥ Modal æ˜¯é–‹å•Ÿçš„ï¼ŒåŒæ­¥åˆ·æ–°ç•™è¨€
            const modal = document.getElementById('commentModal');
            if (modal.style.display === 'block' && activeCardId) {
                const updated = allData.find(d => d.id === activeCardId);
                if (updated) renderComments(updated);
            }
        }, (err) => {
            console.error(err);
            showToast('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
        });
    }

    // â”€â”€ ä¿®æ­£ï¼štype â†’ CSS è®Šæ•¸å°æ‡‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getTypeKey(type) {
        const t = (type || '').toLowerCase();
        if (t.includes('arteries') || t.includes('veins')) return 'vessel';
        if (t.includes('muscle')) return 'muscle';
        if (t.includes('nerve')) return 'nerve';
        return 'other';
    }

    // â”€â”€ æ¸²æŸ“å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
        const grid = document.getElementById('card-grid');
        grid.innerHTML = "";

        let filtered = allData.filter(d => {
            // åœ°å€ç¯©é¸
            if (currentRegion !== null && String(d.region) !== String(currentRegion)) return false;
            // åˆ†é¡ç¯©é¸
            if (currentFilter === 'å…¨éƒ¨') return true;
            if (currentFilter === 'Vessel') {
                return (d.type || '').toLowerCase().includes('arteries') || 
                       (d.type || '').toLowerCase().includes('veins');
            }
            return (d.type || '').toLowerCase() === currentFilter.toLowerCase();
        });

        // ç©ºç™½ç‹€æ…‹
        if (filtered.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <p style="font-size:2rem;">ğŸ”</p>
                    <p>æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</p>
                </div>`;
            return;
        }

        filtered.forEach(data => {
            const wrap = document.createElement('div');
            wrap.className = 'card-container';
            const typeKey = getTypeKey(data.type);

            wrap.innerHTML = `
                <div class="card" onclick="this.classList.toggle('flipped')">
                    <div class="card-front">
                        <span class="badge" style="background:var(--${typeKey})">${data.type || 'Other'}</span>
                        <h3>${data.en || ''}</h3>
                    </div>
                    <div class="card-back">
                        <h3>${data.ch || ''}</h3>
                        <button 
                            onclick="event.stopPropagation(); window.openNotes('${data.id}')" 
                            style="cursor:pointer; padding:6px 14px; border:1px solid rgba(255,255,255,0.5); background:transparent; color:white; border-radius:5px;">
                            ğŸ“ ç­†è¨˜ç•™è¨€
                        </button>
                    </div>
                </div>
            `;
            grid.appendChild(wrap);
        });
    }

    // â”€â”€ åˆ†é¡ç¯©é¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.getAttribute('data-cat');
            render();
        };
    });

    // â”€â”€ åœ°å€ç¯©é¸ï¼ˆå´é‚Šæ¬„ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('#region-list li').forEach(li => {
        li.onclick = () => {
            const region = li.getAttribute('data-region');
            if (currentRegion === region) {
                // å†æ¬¡é»æ“Šå–æ¶ˆç¯©é¸
                currentRegion = null;
                document.querySelectorAll('#region-list li').forEach(l => l.classList.remove('active-region'));
            } else {
                currentRegion = region;
                document.querySelectorAll('#region-list li').forEach(l => l.classList.remove('active-region'));
                li.classList.add('active-region');
            }
            render();
        };
    });

    // â”€â”€ ç•™è¨€è¦–çª— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    window.openNotes = (id) => {
        activeCardId = id;
        const data = allData.find(d => d.id === id);
        if (!data) return;
        document.getElementById('modal-title').innerText = `${data.en} (${data.ch})`;
        renderComments(data);
        document.getElementById('commentModal').style.display = 'block';
    };

    function renderComments(data) {
        const list = document.getElementById('comments-list');
        if (!data.comments || data.comments.length === 0) {
            list.innerHTML = '<p style="color:#95a5a6; text-align:center;">å°šç„¡ç­†è¨˜</p>';
            return;
        }
        list.innerHTML = data.comments.map((c, idx) => {
            const isOwner = currentUser && c.user === currentUser.displayName;
            return `
                <div class="comment-item">
                    <div class="comment-text"><b>${c.user}</b>ï¼š${c.text}</div>
                    ${isOwner ? `<button class="delete-btn" data-idx="${idx}">åˆªé™¤</button>` : ''}
                </div>
            `;
        }).join('');

        // ç¶å®šåˆªé™¤æŒ‰éˆ•
        list.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = async () => {
                const idx = parseInt(btn.getAttribute('data-idx'));
                const data = allData.find(d => d.id === activeCardId);
                const commentToRemove = data.comments[idx];
                try {
                    await updateDoc(doc(db, "flashcards", activeCardId), {
                        comments: arrayRemove(commentToRemove)
                    });
                    showToast('ç­†è¨˜å·²åˆªé™¤', 'success');
                    // ç­‰ onSnapshot æ›´æ–°å¾Œ re-render
                } catch (err) {
                    console.error(err);
                    showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
                }
            };
        });
    }

    // onSnapshot è§¸ç™¼æ™‚è‹¥ modal æ˜¯é–‹å•Ÿçš„ï¼ŒåŒæ­¥æ›´æ–°ç•™è¨€
    onAuthStateChanged(auth, () => {}); // ç¢ºä¿ auth åˆå§‹åŒ–
    // é€éç›£è½ allData æ›´æ–°ï¼ˆåœ¨ loadData çš„ onSnapshot è£¡ï¼‰è‡ªå‹•è§¸ç™¼ openNotes åˆ·æ–°
    // åˆ©ç”¨ MutationObserver æˆ–ç›´æ¥åœ¨ snapshot callback ä¸­åˆ·æ–° modal
    // å·²åœ¨ onSnapshot ä¸­å‘¼å« render()ï¼Œä¸¦åœ¨ render å‰æª¢æŸ¥ modal

    // åœ¨ loadData çš„ onSnapshot ä¸­é¡å¤–è™•ç† modal åˆ·æ–°
    // ï¼ˆé‡æ–°å®šç¾©ï¼Œæ­¤è™•å°‡ modal åˆ·æ–°é‚è¼¯æ³¨å…¥ render ä¹‹å¾Œï¼‰
    const _origLoadData = loadData;
    
    // â”€â”€ é€å‡ºç•™è¨€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('send-btn').onclick = async () => {
        const input = document.getElementById('comment-input');
        const text = input.value.trim();
        if (!currentUser) { showToast('è«‹å…ˆç™»å…¥', 'error'); return; }
        if (!text) { showToast('è«‹è¼¸å…¥ç­†è¨˜å…§å®¹', 'error'); return; }
        try {
            await updateDoc(doc(db, "flashcards", activeCardId), {
                comments: arrayUnion({ user: currentUser.displayName, text })
            });
            input.value = "";
            showToast('ç­†è¨˜å·²å„²å­˜', 'success');
        } catch (err) {
            console.error(err);
            showToast('å„²å­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
        }
    };

    // Enter éµé€å‡º
    document.getElementById('comment-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') document.getElementById('send-btn').click();
    });

    // â”€â”€ é—œé–‰ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('close-modal-btn').onclick = () => {
        document.getElementById('commentModal').style.display = 'none';
    };

    // é»æ“ŠèƒŒæ™¯é—œé–‰
    document.getElementById('commentModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('commentModal')) {
            document.getElementById('commentModal').style.display = 'none';
        }
    });
</script>
</body>
</html>
