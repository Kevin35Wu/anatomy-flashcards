<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anatomy Pro</title>
    <style>
        :root { 
            --muscle: #e67e22; --nerve: #f1c40f; 
            --vessel: #e74c3c; --other: #95a5a6; --main: #2c3e50; 
        }
        * { box-sizing: border-box; }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; background: #f4f7f6; display: flex; }

        /* â”€â”€ å´é‚Šæ¬„ â”€â”€ */
        nav { 
            width: 250px; background: var(--main); color: white; 
            height: 100vh; padding: 20px; position: fixed; left: 0; top: 0;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        nav h2 { border-bottom: 1px solid #555; padding-bottom: 10px; margin-top: 0; font-size: 1rem; }
        nav ul { list-style: none; padding: 0; margin: 0; }
        nav li { padding: 10px 12px; cursor: pointer; border-radius: 4px; transition: 0.3s; font-size: 0.85rem; }
        nav li:hover { background: #34495e; }
        nav li.active-region { background: #1abc9c; }

        .drive-btn {
            display: block; margin: 10px 0; padding: 10px;
            background: #27ae60; color: white; text-decoration: none;
            border-radius: 6px; text-align: center; font-size: 0.85rem;
            transition: 0.3s;
        }
        .drive-btn:hover { background: #219a52; }

        .user-box { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin-top: auto; text-align: center; }

        /* â”€â”€ ä¸»ç•«é¢ â”€â”€ */
        main { margin-left: 250px; flex-grow: 1; min-height: 100vh; display: flex; flex-direction: column; }

        /* â”€â”€ é ‚éƒ¨ç¯©é¸ â”€â”€ */
        .top-filter {
            position: sticky; top: 0; z-index: 100;
            background: white; padding: 12px 25px;
            display: flex; gap: 10px; flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-items: center;
        }
        .filter-btn {
            padding: 7px 18px; border: 1px solid #ddd; border-radius: 20px;
            cursor: pointer; background: white; font-weight: bold; transition: 0.3s; font-size: 0.85rem;
        }
        .filter-btn.active { background: var(--main); color: white; border-color: var(--main); }

        /* â”€â”€ å…¬å‘Šå°ˆå€ â”€â”€ */
        .announce-section {
            margin: 20px 25px 0; background: white; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden;
        }
        .announce-header {
            background: var(--main); color: white; padding: 12px 18px;
            font-weight: bold; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;
        }
        .announce-list { max-height: 200px; overflow-y: auto; }
        .announce-item {
            padding: 10px 18px; border-bottom: 1px solid #f0f0f0;
            font-size: 0.85rem; display: flex; justify-content: space-between;
            align-items: center; gap: 10px; transition: background 0.2s;
        }
        .announce-item:hover { background: #f8f9fa; }
        .announce-item:last-child { border-bottom: none; }
        .announce-item .announce-text { flex: 1; }
        .announce-item .announce-text b { color: #1abc9c; }
        .announce-item .announce-time { color: #95a5a6; font-size: 0.75rem; flex-shrink: 0; }
        .announce-link-btn {
            padding: 3px 10px; font-size: 0.75rem; background: var(--main);
            color: white; border: none; border-radius: 4px; cursor: pointer; flex-shrink: 0;
        }
        .announce-empty { padding: 20px; text-align: center; color: #95a5a6; font-size: 0.85rem; }

        /* â”€â”€ å¡ç‰‡å€ â”€â”€ */
        .container { padding: 20px 25px 30px; }
        .card-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 18px;
        }
        @media (max-width: 1400px) { .card-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 1000px) { .card-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .card-grid { grid-template-columns: 1fr; } }

        .card-container { perspective: 1000px; min-height: 175px; }
        .card { 
            width: 100%; height: 100%; min-height: 175px;
            transition: transform 0.6s; transform-style: preserve-3d; 
            cursor: pointer; position: relative; 
        }
        .card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute; width: 100%; min-height: 175px;
            backface-visibility: hidden; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center;
        }
        .card-front { background: white; border-bottom: 5px solid var(--main); }
        .card-back { background: var(--main); color: white; transform: rotateY(180deg); }
        .card-front h3, .card-back h3 { 
            margin: 8px 0; padding: 0 8px;
            word-break: break-word; font-size: clamp(0.8rem, 1.4vw, 1rem);
        }
        .badge { 
            position: absolute; top: 10px; right: 10px; font-size: 0.65rem; 
            color: white; padding: 2px 7px; border-radius: 5px; 
        }
        .card-back .note-count {
            font-size: 0.75rem; opacity: 0.7; margin-bottom: 5px;
        }

        /* â”€â”€ Loading / Empty â”€â”€ */
        .loading-state, .empty-state {
            grid-column: 1/-1; text-align: center; padding: 80px; color: #95a5a6;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #ddd;
            border-top-color: var(--main); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* â”€â”€ Modal â”€â”€ */
        .modal { 
            display: none; position: fixed; z-index: 1000; 
            left: 0; top: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
        }
        .modal-content { 
            background: white; margin: 3% auto; padding: 25px; 
            width: 90%; max-width: 520px; border-radius: 15px; 
        }
        .modal-content h2 { margin-top: 0; font-size: 1.1rem; }

        /* ç•™è¨€é …ç›® */
        .comment-item { 
            background: #f0f2f5; padding: 10px 12px; border-radius: 8px; 
            margin-bottom: 10px; font-size: 0.88rem; text-align: left;
        }
        .comment-item .comment-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px;
        }
        .comment-item .comment-user { font-weight: bold; color: var(--main); }
        .comment-item .comment-time { font-size: 0.75rem; color: #95a5a6; }
        .comment-item .delete-btn {
            background: none; border: none; cursor: pointer;
            color: #e74c3c; font-size: 0.78rem; padding: 0; margin-left: 8px;
        }
        .comment-item .delete-btn:hover { text-decoration: underline; }
        .comment-item .comment-body { word-break: break-word; }

        /* åª’é«”é¡¯ç¤º */
        .comment-item img { 
            max-width: 100%; border-radius: 6px; margin-top: 6px; 
            cursor: pointer; display: block;
        }
        .comment-item iframe { 
            width: 100%; height: 200px; border: none; 
            border-radius: 6px; margin-top: 6px; display: block;
        }
        .comment-item .drive-preview {
            display: flex; align-items: center; gap: 8px;
            background: #e8f5e9; padding: 8px 10px; border-radius: 6px;
            margin-top: 6px; text-decoration: none; color: #27ae60; font-size: 0.82rem;
        }

        /* è¼¸å…¥å€ */
        .input-area { margin-top: 12px; }
        .input-area .hint {
            font-size: 0.75rem; color: #95a5a6; margin-bottom: 6px;
        }
        .input-row { display: flex; gap: 8px; }
        .input-row input {
            flex: 1; padding: 10px; border: 1px solid #ddd; 
            border-radius: 5px; outline: none; font-size: 0.9rem;
        }
        .input-row button {
            padding: 10px 18px; background: var(--main); color: white; 
            border: none; border-radius: 5px; cursor: pointer; white-space: nowrap;
        }
        .close-btn {
            width: 100%; margin-top: 12px; padding: 10px; 
            border: none; background: #eee; cursor: pointer; border-radius: 5px;
        }

        /* â”€â”€ Toast â”€â”€ */
        .toast {
            position: fixed; bottom: 30px; right: 30px; z-index: 9999;
            background: #2c3e50; color: white; padding: 12px 20px;
            border-radius: 8px; font-size: 0.9rem;
            transform: translateY(100px); opacity: 0; transition: all 0.3s ease;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.error { background: #e74c3c; }
        .toast.success { background: #27ae60; }

        /* åœ–ç‰‡ç‡ˆç®± */
        .lightbox {
            display: none; position: fixed; z-index: 9998;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); align-items: center; justify-content: center;
        }
        .lightbox.show { display: flex; }
        .lightbox img { max-width: 90%; max-height: 90vh; border-radius: 8px; }
        .lightbox-close { 
            position: absolute; top: 20px; right: 30px; color: white; 
            font-size: 2rem; cursor: pointer;
        }
    </style>
</head>
<body>

<nav>
    <h2>ğŸ“ è§£å‰–éƒ¨ä½</h2>
    <ul id="region-list">
        <li data-region="1">1. èƒŒéƒ¨èˆ‡é ¸å¾Œå€</li>
        <li data-region="2">2. èƒ¸éƒ¨èˆ‡è…‹çª©å€</li>
        <li data-region="3">3. è‚©èƒ›ã€è‡‚éƒ¨èˆ‡è‚˜å€</li>
        <li data-region="4">4. å‰è‡‚å€</li>
        <li data-region="5">5. æ‰‹éƒ¨</li>
    </ul>

    <div style="margin-top: 15px;">
        <p style="font-size:0.8rem; color:#95a5a6; margin:0 0 5px;">ğŸ“ å…±ç”¨ç´ æè³‡æ–™å¤¾</p>
        <a class="drive-btn" href="https://drive.google.com/drive/folders/15K0Z4mQYISFuY5FuCQBcBwY1mVBTjcrX?usp=sharing" target="_blank">
            ğŸ“‚ é–‹å•Ÿ Google Drive
        </a>
        <p style="font-size:0.72rem; color:#95a5a6; margin:4px 0 0;">ä¸Šå‚³åœ–ç‰‡ï¼å½±ç‰‡å¾Œï¼Œè¤‡è£½é€£çµè²¼å…¥ç•™è¨€å³å¯é¡¯ç¤º</p>
    </div>

    <div class="user-box" id="user-info">
        <p>æª¢æŸ¥ç‹€æ…‹ä¸­...</p>
    </div>
</nav>

<main>
    <div class="top-filter">
        <button class="filter-btn active" data-cat="å…¨éƒ¨">å…¨éƒ¨</button>
        <button class="filter-btn" data-cat="Muscles">è‚Œè‚‰</button>
        <button class="filter-btn" data-cat="Nerves">ç¥ç¶“</button>
        <button class="filter-btn" data-cat="Vessel">è¡€ç®¡</button>
        <button class="filter-btn" data-cat="Other">å…¶ä»–</button>
    </div>

    <!-- å…¬å‘Šå°ˆå€ -->
    <div class="announce-section" id="announce-section" style="display:none;">
        <div class="announce-header">ğŸ“¢ æœ€æ–°å‹•æ…‹</div>
        <div class="announce-list" id="announce-list">
            <div class="announce-empty">æš«ç„¡å‹•æ…‹</div>
        </div>
    </div>

    <div class="container">
        <div id="card-grid" class="card-grid">
            <div class="loading-state">
                <h2>ğŸ”’ å·²é–å®šå…§å®¹</h2>
                <p>è«‹å…ˆä½¿ç”¨ Google å¸³è™Ÿç™»å…¥</p>
            </div>
        </div>
    </div>
</main>

<!-- ç•™è¨€ Modal -->
<div id="commentModal" class="modal">
    <div class="modal-content">
        <h2 id="modal-title"></h2>
        <div id="comments-list" style="max-height: 320px; overflow-y: auto; margin: 12px 0;"></div>
        <div class="input-area">
            <div class="hint">ğŸ’¡ å¯è²¼å…¥æ–‡å­—ã€Google Drive åœ–ç‰‡ï¼å½±ç‰‡é€£çµã€YouTube é€£çµ</div>
            <div class="input-row">
                <input type="text" id="comment-input" placeholder="æ–°å¢ç­†è¨˜æˆ–è²¼å…¥é€£çµ...">
                <button id="send-btn">é€å‡º</button>
            </div>
        </div>
        <button class="close-btn" id="close-modal-btn">é—œé–‰</button>
    </div>
</div>

<!-- åœ–ç‰‡ç‡ˆç®± -->
<div class="lightbox" id="lightbox">
    <span class="lightbox-close" id="lightbox-close">âœ•</span>
    <img id="lightbox-img" src="" alt="">
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getFirestore, collection, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove,
    addDoc, query, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
    getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyB43JZQ7qXrcU_WkVHGEPeZdmicXcmjbq0",
    authDomain: "anatomy-dc089.firebaseapp.com",
    projectId: "anatomy-dc089",
    storageBucket: "anatomy-dc089.firebasestorage.app",
    messagingSenderId: "742909907454",
    appId: "1:742909907454:web:5afaaf70fc1b41247270af"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();
const provider = new GoogleAuthProvider();

let allData = [];
let currentFilter = 'å…¨éƒ¨';
let currentRegion = null;
let currentUser = null;
let activeCardId = null;

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = `toast ${type} show`;
    setTimeout(() => { toast.className = 'toast'; }, 3000);
}

// â”€â”€ æ™‚é–“æ ¼å¼åŒ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatTime(ts) {
    if (!ts) return '';
    const d = ts.toDate ? ts.toDate() : new Date(ts);
    const pad = n => String(n).padStart(2, '0');
    return `${d.getMonth()+1}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

// â”€â”€ é€£çµé¡å‹åµæ¸¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectLinkType(text) {
    if (!text) return 'text';
    const t = text.trim();
    // YouTube
    if (/youtube\.com\/watch|youtu\.be\//.test(t)) return 'youtube';
    // Google Drive å½±ç‰‡ï¼ˆå¸¸è¦‹å‰¯æª”åï¼‰
    if (/drive\.google\.com/.test(t) && /\.(mp4|mov|avi|mkv)/i.test(t)) return 'drive-video';
    // Google Drive åœ–ç‰‡
    if (/drive\.google\.com/.test(t) && /\.(jpg|jpeg|png|gif|webp)/i.test(t)) return 'drive-image';
    // Google Drive ä¸€èˆ¬é€£çµ
    if (/drive\.google\.com/.test(t)) return 'drive-link';
    // ç›´æ¥åœ–ç‰‡ç¶²å€
    if (/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(t)) return 'image';
    // æ™®é€šç¶²å€
    if (/^https?:\/\//.test(t)) return 'link';
    return 'text';
}

// â”€â”€ å–å¾— YouTube embed URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getYouTubeEmbedUrl(url) {
    let id = '';
    const match = url.match(/(?:v=|youtu\.be\/)([^&?/]+)/);
    if (match) id = match[1];
    return id ? `https://www.youtube.com/embed/${id}` : null;
}

// â”€â”€ å–å¾— Google Drive åµŒå…¥ URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDriveEmbedUrl(url) {
    const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match) return `https://drive.google.com/file/d/${match[1]}/preview`;
    const match2 = url.match(/id=([a-zA-Z0-9_-]+)/);
    if (match2) return `https://drive.google.com/file/d/${match2[1]}/preview`;
    return null;
}

// â”€â”€ æ¸²æŸ“ç•™è¨€å…§å®¹ï¼ˆå«åª’é«”åµæ¸¬ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCommentContent(text) {
    const type = detectLinkType(text);
    if (type === 'youtube') {
        const embedUrl = getYouTubeEmbedUrl(text);
        return embedUrl 
            ? `<div class="comment-body"><a href="${text}" target="_blank">${text}</a><br><iframe src="${embedUrl}" allowfullscreen></iframe></div>`
            : `<div class="comment-body"><a href="${text}" target="_blank">${text}</a></div>`;
    }
    if (type === 'drive-video' || type === 'drive-link') {
        const embedUrl = getDriveEmbedUrl(text);
        if (embedUrl) {
            return `<div class="comment-body"><iframe src="${embedUrl}" allowfullscreen></iframe></div>`;
        }
        return `<div class="comment-body"><a class="drive-preview" href="${text}" target="_blank">ğŸ“ é–‹å•Ÿ Google Drive æª”æ¡ˆ</a></div>`;
    }
    if (type === 'drive-image') {
        const embedUrl = getDriveEmbedUrl(text);
        if (embedUrl) {
            return `<div class="comment-body"><img src="${embedUrl}" onclick="window.openLightbox('${embedUrl}')"></div>`;
        }
    }
    if (type === 'image') {
        return `<div class="comment-body"><img src="${text}" onclick="window.openLightbox('${text}')"></div>`;
    }
    if (type === 'link') {
        return `<div class="comment-body"><a href="${text}" target="_blank">${text}</a></div>`;
    }
    return `<div class="comment-body">${text}</div>`;
}

// â”€â”€ ç‡ˆç®± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openLightbox = (src) => {
    document.getElementById('lightbox-img').src = src;
    document.getElementById('lightbox').classList.add('show');
};
document.getElementById('lightbox-close').onclick = () => {
    document.getElementById('lightbox').classList.remove('show');
};
document.getElementById('lightbox').onclick = (e) => {
    if (e.target === document.getElementById('lightbox')) {
        document.getElementById('lightbox').classList.remove('show');
    }
};

// â”€â”€ ç™»å…¥ç‹€æ…‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onAuthStateChanged(auth, (user) => {
    const userInfoBox = document.getElementById('user-info');
    if (user) {
        currentUser = user;
        userInfoBox.innerHTML = `
            <img src="${user.photoURL}" style="width:35px; border-radius:50%; border:2px solid white;"><br>
            <small>${user.displayName}</small><br>
            <button id="logout-btn" style="margin-top:5px; cursor:pointer; padding:2px 8px; border-radius:4px;">ç™»å‡º</button>
        `;
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        loadData();
        loadAnnouncements();
    } else {
        currentUser = null;
        userInfoBox.innerHTML = `
            <button id="login-btn" style="width:100%; padding:10px; cursor:pointer; border-radius:5px;">
                ğŸ”‘ Google ç™»å…¥
            </button>
        `;
        document.getElementById('login-btn').onclick = () => {
            signInWithPopup(auth, provider).catch(() => {
                showToast('ç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firebase Authentication å·²å•Ÿç”¨ Google æä¾›è€…ï¼', 'error');
            });
        };
        document.getElementById('card-grid').innerHTML = `
            <div class="loading-state">
                <h2>ğŸ”’ å·²é–å®šå…§å®¹</h2>
                <p>è«‹é»æ“Šå·¦å´æŒ‰éˆ•ç™»å…¥</p>
            </div>`;
        document.getElementById('announce-section').style.display = 'none';
    }
});

// â”€â”€ è¼‰å…¥å–®å­—å¡è³‡æ–™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadData() {
    document.getElementById('card-grid').innerHTML = `
        <div class="loading-state"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>`;

    onSnapshot(collection(db, "flashcards"), (snap) => {
        allData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        render();
        const modal = document.getElementById('commentModal');
        if (modal.style.display === 'block' && activeCardId) {
            const updated = allData.find(d => d.id === activeCardId);
            if (updated) renderComments(updated);
        }
    }, (err) => {
        console.error(err);
        showToast('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
    });
}

// â”€â”€ è¼‰å…¥å…¬å‘Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadAnnouncements() {
    document.getElementById('announce-section').style.display = 'block';
    const q = query(collection(db, "announcements"), orderBy("time", "desc"), limit(20));
    onSnapshot(q, (snap) => {
        const list = document.getElementById('announce-list');
        if (snap.empty) {
            list.innerHTML = '<div class="announce-empty">ç›®å‰æš«ç„¡å‹•æ…‹</div>';
            return;
        }
        list.innerHTML = snap.docs.map(d => {
            const a = d.data();
            return `
                <div class="announce-item">
                    <div class="announce-text">
                        <b>${a.user}</b> ${a.action}äº†ä¸€å‰‡${a.contentType}åœ¨ <b>${a.cardEn}</b>
                    </div>
                    <span class="announce-time">${formatTime(a.time)}</span>
                    <button class="announce-link-btn" onclick="window.jumpToCard('${a.cardId}')">å‰å¾€</button>
                </div>
            `;
        }).join('');
    }, (err) => { console.error(err); });
}

// â”€â”€ è·³è½‰è‡³å–®å­—å¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.jumpToCard = (cardId) => {
    // æ¸…é™¤ç¯©é¸
    currentFilter = 'å…¨éƒ¨';
    currentRegion = null;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.filter-btn[data-cat="å…¨éƒ¨"]').classList.add('active');
    document.querySelectorAll('#region-list li').forEach(l => l.classList.remove('active-region'));
    render();

    // ç­‰ render å®Œå† scroll
    setTimeout(() => {
        const el = document.getElementById(`card-${cardId}`);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.style.outline = '3px solid #1abc9c';
            setTimeout(() => { el.style.outline = ''; }, 2000);
        }
        // è‡ªå‹•é–‹å•Ÿç•™è¨€
        window.openNotes(cardId);
    }, 100);
};

// â”€â”€ æ–°å¢å…¬å‘Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function addAnnouncement(action, cardId, cardEn, contentType) {
    try {
        await addDoc(collection(db, "announcements"), {
            user: currentUser.displayName,
            action,
            cardId,
            cardEn,
            contentType,
            time: new Date()
        });
    } catch (err) { console.error('å…¬å‘Šæ–°å¢å¤±æ•—', err); }
}

// â”€â”€ type â†’ CSS è®Šæ•¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTypeKey(type) {
    const t = (type || '').toLowerCase();
    if (t.includes('arteries') || t.includes('veins')) return 'vessel';
    if (t.includes('muscle')) return 'muscle';
    if (t.includes('nerve')) return 'nerve';
    return 'other';
}

// â”€â”€ æ¸²æŸ“å¡ç‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    const grid = document.getElementById('card-grid');
    grid.innerHTML = "";

    let filtered = allData.filter(d => {
        if (currentRegion !== null && String(d.region) !== String(currentRegion)) return false;
        if (currentFilter === 'å…¨éƒ¨') return true;
        if (currentFilter === 'Vessel') {
            return (d.type || '').toLowerCase().includes('arteries') || 
                   (d.type || '').toLowerCase().includes('veins');
        }
        return (d.type || '').toLowerCase() === currentFilter.toLowerCase();
    });

    if (filtered.length === 0) {
        grid.innerHTML = `<div class="empty-state"><p style="font-size:2rem;">ğŸ”</p><p>æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™</p></div>`;
        return;
    }

    filtered.forEach(data => {
        const wrap = document.createElement('div');
        wrap.className = 'card-container';
        wrap.id = `card-${data.id}`;
        const typeKey = getTypeKey(data.type);
        const noteCount = (data.comments || []).length;

        wrap.innerHTML = `
            <div class="card" onclick="this.classList.toggle('flipped')">
                <div class="card-front">
                    <span class="badge" style="background:var(--${typeKey})">${data.type || 'Other'}</span>
                    <h3>${data.en || ''}</h3>
                </div>
                <div class="card-back">
                    <h3>${data.ch || ''}</h3>
                    ${noteCount > 0 ? `<div class="note-count">ğŸ“ ${noteCount} å‰‡ç­†è¨˜</div>` : ''}
                    <button 
                        onclick="event.stopPropagation(); window.openNotes('${data.id}')" 
                        style="cursor:pointer; padding:6px 14px; border:1px solid rgba(255,255,255,0.5); background:transparent; color:white; border-radius:5px;">
                        ğŸ“ ç­†è¨˜ç•™è¨€
                    </button>
                </div>
            </div>
        `;
        grid.appendChild(wrap);
    });
}

// â”€â”€ ç¯©é¸æŒ‰éˆ• â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.getAttribute('data-cat');
        render();
    };
});

// â”€â”€ åœ°å€ç¯©é¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('#region-list li').forEach(li => {
    li.onclick = () => {
        const region = li.getAttribute('data-region');
        if (currentRegion === region) {
            currentRegion = null;
            document.querySelectorAll('#region-list li').forEach(l => l.classList.remove('active-region'));
        } else {
            currentRegion = region;
            document.querySelectorAll('#region-list li').forEach(l => l.classList.remove('active-region'));
            li.classList.add('active-region');
        }
        render();
    };
});

// â”€â”€ é–‹å•Ÿç•™è¨€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openNotes = (id) => {
    activeCardId = id;
    const data = allData.find(d => d.id === id);
    if (!data) return;
    document.getElementById('modal-title').innerText = `${data.en} (${data.ch})`;
    renderComments(data);
    document.getElementById('commentModal').style.display = 'block';
};

// â”€â”€ æ¸²æŸ“ç•™è¨€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderComments(data) {
    const list = document.getElementById('comments-list');
    if (!data.comments || data.comments.length === 0) {
        list.innerHTML = '<p style="color:#95a5a6; text-align:center; padding:10px;">å°šç„¡ç­†è¨˜</p>';
        return;
    }
    list.innerHTML = data.comments.map((c, idx) => {
        const isOwner = currentUser && c.user === currentUser.displayName;
        const timeStr = c.time ? formatTime({ toDate: () => new Date(c.time) }) : '';
        return `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">${c.user}</span>
                    <span>
                        <span class="comment-time">${timeStr}</span>
                        ${isOwner ? `<button class="delete-btn" data-idx="${idx}">åˆªé™¤</button>` : ''}
                    </span>
                </div>
                ${renderCommentContent(c.text)}
            </div>
        `;
    }).join('');

    // ç¶å®šåˆªé™¤
    list.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async () => {
            const idx = parseInt(btn.getAttribute('data-idx'));
            const cardData = allData.find(d => d.id === activeCardId);
            const commentToRemove = cardData.comments[idx];
            const contentType = detectLinkType(commentToRemove.text) === 'text' ? 'ç­†è¨˜' : 'åª’é«”';
            try {
                await updateDoc(doc(db, "flashcards", activeCardId), {
                    comments: arrayRemove(commentToRemove)
                });
                await addAnnouncement('åˆªé™¤', activeCardId, cardData.en, contentType);
                showToast('å·²åˆªé™¤', 'success');
            } catch (err) {
                console.error(err);
                showToast('åˆªé™¤å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
            }
        };
    });
}

// â”€â”€ é€å‡ºç•™è¨€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('send-btn').onclick = async () => {
    const input = document.getElementById('comment-input');
    const text = input.value.trim();
    if (!currentUser) { showToast('è«‹å…ˆç™»å…¥', 'error'); return; }
    if (!text) { showToast('è«‹è¼¸å…¥å…§å®¹', 'error'); return; }

    const cardData = allData.find(d => d.id === activeCardId);
    const contentType = detectLinkType(text) === 'text' ? 'ç­†è¨˜' : 'åª’é«”';

    try {
        await updateDoc(doc(db, "flashcards", activeCardId), {
            comments: arrayUnion({ 
                user: currentUser.displayName, 
                text,
                time: new Date().toISOString()
            })
        });
        await addAnnouncement('æ–°å¢', activeCardId, cardData.en, contentType);
        input.value = "";
        showToast('å·²å„²å­˜', 'success');
    } catch (err) {
        console.error(err);
        showToast('å„²å­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡', 'error');
    }
};

document.getElementById('comment-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('send-btn').click();
});

// â”€â”€ é—œé–‰ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('close-modal-btn').onclick = () => {
    document.getElementById('commentModal').style.display = 'none';
};
document.getElementById('commentModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('commentModal')) {
        document.getElementById('commentModal').style.display = 'none';
    }
});
</script>
</body>
</html>
