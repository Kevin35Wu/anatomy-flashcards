<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Anatomy Pro</title>
<style>
:root{--muscle:#c0704a;--nerve:#8fa8b0;--vessel:#b05555;--other:#7a96a4;--main:#3f5661;--green:#4a7c6f;--teal:#5b8fa8;--hover:#7a96a4;--light:#e6eff3;--bg:#f0f4f6;}
*{box-sizing:border-box;}
body{font-family:"Microsoft JhengHei","PingFang TC",system-ui,sans-serif;margin:0;background:#edf2f4;display:flex;}
nav{width:220px;background:var(--main);color:white;height:100vh;height:-webkit-fill-available;padding:15px 12px;padding-bottom:max(15px,env(safe-area-inset-bottom));position:fixed;left:0;top:0;bottom:0;display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;-webkit-overflow-scrolling:touch;}
.nav-logo{font-size:1rem;font-weight:700;letter-spacing:0.02em;border-bottom:1px solid #455a6a;padding-bottom:8px;margin-bottom:10px;}
.nav-btn{display:flex;align-items:center;gap:8px;padding:9px 10px;border-radius:6px;cursor:pointer;font-size:0.83rem;transition:0.2s;margin-bottom:3px;border:none;background:none;color:white;width:100%;text-align:left;}
.nav-btn:hover{background:#536e7a;}
.nav-btn.active{background:var(--hover);font-weight:600;}
.nav-divider{border:none;border-top:1px solid #455a6a;margin:8px 0;}
#region-list{list-style:none;padding:0;margin:0 0 6px;overflow-y:auto;flex-shrink:1;max-height:180px;}
#region-list li{padding:7px 10px;cursor:pointer;border-radius:4px;transition:0.2s;font-size:0.78rem;color:#bdc3c7;}
#region-list li:hover{background:#536e7a;color:white;}
#region-list li.active-region{background:var(--hover);color:white;}
.region-label{font-size:0.72rem;color:#7f8c8d;padding:4px 10px 2px;}
.drive-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:7px;background:#4a7c6f;color:white;text-decoration:none;border-radius:6px;font-size:0.78rem;transition:0.2s;margin-bottom:3px;}
.drive-btn:hover{background:#3d6b5f;}
.drive-hint{font-size:0.68rem;color:#7f8c8d;margin:0 0 8px;padding:0 2px;}
.user-box{background:rgba(255,255,255,0.07);padding:10px;border-radius:8px;margin-top:auto;text-align:center;flex-shrink:0;min-height:60px;position:relative;}
@media not all and (min-resolution:.001dpcm){@supports(-webkit-appearance:none){nav{height:100%;}}}
  nav{width:180px;}
  main{margin-left:180px;}
  .card-grid{grid-template-columns:repeat(2,1fr);}
  .nav-logo{font-size:0.88rem;}
  .nav-btn{font-size:0.78rem;padding:8px 8px;}
  #region-list li{font-size:0.72rem;}
}
@media(max-width:600px){
  nav{width:160px;}
  main{margin-left:160px;}
  .card-grid{grid-template-columns:1fr;}
  .top-filter{gap:5px;padding:8px 12px;}
  .filter-btn{width:52px;font-size:0.72rem;}
}
main{margin-left:220px;flex-grow:1;min-height:100vh;display:flex;flex-direction:column;}
.panel{display:none;flex:1;flex-direction:column;min-height:100vh;}
.panel.active{display:flex;}

/* â”€â”€ é ‚éƒ¨ç¯©é¸åˆ— â”€â”€ */
.top-filter{position:sticky;top:0;z-index:100;background:#fff;padding:10px 20px;display:flex;gap:8px;flex-wrap:wrap;box-shadow:0 1px 4px rgba(63,86,97,0.1);align-items:center;}
.filter-btn{padding:6px 0;border:1px solid #c8d8de;border-radius:20px;cursor:pointer;background:white;font-weight:500;transition:0.2s;font-size:0.8rem;width:64px;text-align:center;}
.filter-btn:hover{background:var(--light);border-color:var(--hover);}
.filter-btn.active{background:var(--main);color:white;border-color:var(--main);}
.filter-btn.special-btn.active[data-cat="æ„›å¿ƒ"]{background:#e74c3c;border-color:#e74c3c;color:white;}
.filter-btn.bookmark-filter-btn{display:flex;align-items:center;justify-content:center;width:64px;padding:5px 0;}
.filter-btn.bookmark-filter-btn svg{width:18px;height:18px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
.filter-btn.bookmark-filter-btn.active svg{stroke:white;fill:white;}
.filter-btn.bookmark-filter-btn.active[data-cat="æ„›å¿ƒ"]{background:#e74c3c;border-color:#e74c3c;}
.add-card-btn{padding:6px 14px;background:var(--main);color:white;border:none;border-radius:20px;cursor:pointer;font-weight:500;font-size:0.8rem;transition:0.2s;}
.add-card-btn:hover{background:var(--hover);}
.delete-mode-btn{padding:6px 14px;background:white;color:#b05555;border:1px solid #b05555;border-radius:20px;cursor:pointer;font-weight:bold;font-size:0.8rem;transition:0.2s;}
.delete-mode-btn.active{background:#b05555;color:white;}
.delete-mode-btn:hover{background:#b05555;color:white;}
.quiz-start-btn{margin-left:auto;padding:6px 16px;background:var(--teal);color:white;border:none;border-radius:20px;cursor:pointer;font-weight:500;font-size:0.8rem;}
.quiz-start-btn:hover{background:var(--hover);}

/* â”€â”€ IG å¡ç‰‡ â”€â”€ */
.container{padding:15px 20px 30px;}
.card-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
@media(max-width:1400px){.card-grid{grid-template-columns:repeat(3,1fr);}}
@media(max-width:1000px){.card-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:600px){.card-grid{grid-template-columns:1fr;}}
.ig-card{background:white;border-radius:10px;box-shadow:0 2px 8px rgba(63,86,97,0.07),0 0 0 1px rgba(63,86,97,0.05);overflow:visible;transition:transform 0.2s,box-shadow 0.2s;position:relative;}
.ig-card:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(63,86,97,0.13),0 0 0 1px rgba(63,86,97,0.06);}
.ig-card-flip{perspective:1000px;height:175px;cursor:pointer;border-radius:10px 10px 0 0;overflow:hidden;}
.ig-card-inner{width:100%;height:100%;transition:transform 0.55s;transform-style:preserve-3d;position:relative;}
.ig-card-inner.flipped{transform:rotateY(180deg);}
.ig-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:16px;text-align:center;}
.ig-front{background:white;color:#2a3d45;border-left:4px solid var(--card-color,#7a96a4);}
.ig-back{background:linear-gradient(135deg,#3f5661 0%,#536e7a 100%);color:white;transform:rotateY(180deg);}
.ig-badge{font-size:0.58rem;padding:2px 8px;border-radius:10px;margin-bottom:8px;display:inline-block;font-weight:600;letter-spacing:0.03em;}
.ig-face h3{margin:0;font-size:clamp(0.78rem,1.2vw,1rem);word-break:break-word;line-height:1.4;font-weight:600;}
.ig-sub{font-size:0.7rem;opacity:0.55;margin-top:5px;}
.ig-back .ig-sub{color:rgba(255,255,255,0.75);opacity:1;}
.ig-back h3{color:white;}
.ig-actions{display:flex;align-items:center;padding:9px 12px;gap:4px;border-top:1px solid #e6eff3;background:white;border-radius:0 0 10px 10px;}
.ig-act-btn{background:none;border:none;cursor:pointer;padding:4px 6px;border-radius:8px;display:flex;align-items:center;gap:4px;font-size:0.8rem;color:#6a8590;transition:0.15s;line-height:1;}
.ig-act-btn:hover{background:var(--light);}
.ig-act-btn svg{width:22px;height:22px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0;transition:0.15s;}
.ig-act-btn.heart-active svg{stroke:#e74c3c;fill:#e74c3c;}
.ig-act-btn.heart-active{color:#e74c3c;}
.ig-act-btn.saved-active svg{stroke:var(--main);fill:var(--main);}
.ig-act-btn.saved-active{color:var(--main);}
.ig-count{font-size:0.8rem;font-weight:600;}
.ig-spacer{flex:1;}
/* ç®¡ç†å“¡åˆªé™¤æŒ‰éˆ•ï¼ˆåˆªé™¤æ¨¡å¼æ™‚å‡ºç¾ï¼‰ */
.admin-del-btn{position:absolute;top:-8px;left:-8px;z-index:10;background:#b05555;border:2px solid white;border-radius:50%;width:26px;height:26px;cursor:pointer;color:white;font-size:0.8rem;display:none;align-items:center;justify-content:center;box-shadow:0 2px 6px rgba(0,0,0,0.2);transition:transform 0.2s;font-weight:bold;}
.admin-del-btn:hover{transform:scale(1.15);}
.delete-mode-active .admin-del-btn{display:flex;}
.loading-state,.empty-state{grid-column:1/-1;text-align:center;padding:60px;color:#95a5a6;}
.spinner{width:34px;height:34px;border:4px solid #ddd;border-top-color:var(--main);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 14px;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€ å…¬å‘Š â”€â”€ */
.panel-header{background:white;padding:16px 24px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;font-size:1.1rem;font-weight:600;color:var(--main);box-shadow:0 1px 4px rgba(63,86,97,0.08);flex-shrink:0;}
.announce-page{padding:20px 24px;flex:1;overflow-y:auto;}
.announce-card{background:white;border-radius:10px;padding:14px 18px;margin-bottom:10px;box-shadow:0 2px 6px rgba(63,86,97,0.06);display:flex;align-items:center;gap:12px;transition:0.2s;border-left:3px solid var(--teal);}
.announce-card.clickable{cursor:pointer;}
.announce-card.clickable:hover{box-shadow:0 4px 12px rgba(63,86,97,0.12);transform:translateY(-1px);}
.ac-icon{font-size:1.4rem;flex-shrink:0;}
.ac-body{flex:1;}
.ac-main{font-size:0.88rem;color:#333;}
.ac-main b{color:var(--main);}
.ac-card-name{color:var(--teal);font-weight:600;}
.ac-time{font-size:0.75rem;color:#95a5a6;margin-top:3px;}
.ac-goto{padding:5px 12px;background:var(--main);color:white;border:none;border-radius:5px;cursor:pointer;font-size:0.78rem;flex-shrink:0;}
.announce-empty{text-align:center;padding:60px;color:#95a5a6;}

/* â”€â”€ èŠå¤©å®¤ â”€â”€ */
.chat-messages{flex:1;overflow-y:auto;padding:16px 24px;display:flex;flex-direction:column;gap:10px;background:var(--bg);}
.chat-msg{display:flex;gap:10px;align-items:flex-start;max-width:72%;}
.chat-msg.me{flex-direction:row-reverse;align-self:flex-end;}
.chat-msg .avatar{width:34px;height:34px;border-radius:50%;background:var(--main);display:flex;align-items:center;justify-content:center;font-size:0.75rem;color:white;flex-shrink:0;overflow:hidden;}
.chat-msg .avatar img{width:100%;height:100%;object-fit:cover;}
.chat-bubble{background:white;border-radius:10px;padding:8px 12px;box-shadow:0 1px 4px rgba(0,0,0,0.08);max-width:100%;cursor:pointer;}
.chat-msg.me .chat-bubble{background:var(--main);color:white;}
.cb-name{font-size:0.72rem;color:#95a5a6;margin-bottom:3px;font-weight:bold;}
.chat-msg.me .cb-name{color:rgba(255,255,255,0.75);}
.cb-text{font-size:0.88rem;word-break:break-word;}
.cb-time{font-size:0.68rem;color:#95a5a6;margin-top:3px;text-align:right;}
.chat-msg.me .cb-time{color:rgba(255,255,255,0.65);}
.chat-date-divider{text-align:center;font-size:0.72rem;color:#95a5a6;padding:5px 0;}
/* å›å¾©é è¦½ */
.reply-preview{background:rgba(0,0,0,0.05);border-left:3px solid var(--teal);border-radius:4px;padding:4px 8px;margin-bottom:4px;font-size:0.75rem;color:#555;}
.chat-msg.me .reply-preview{background:rgba(255,255,255,0.2);border-left-color:rgba(255,255,255,0.7);color:rgba(255,255,255,0.85);}
/* å›å¾©è¼¸å…¥åˆ— */
.reply-bar{background:var(--light);border-top:1px solid #c8d8de;padding:6px 16px;display:none;align-items:center;gap:8px;font-size:0.82rem;color:#555;flex-shrink:0;}
.reply-bar.show{display:flex;}
.reply-bar-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.reply-cancel{background:none;border:none;cursor:pointer;color:#e74c3c;font-size:1rem;padding:0;flex-shrink:0;}
/* è¼¸å…¥åˆ— */
.chat-input-bar{background:white;padding:10px 16px;border-top:1px solid #eee;display:flex;gap:8px;align-items:center;flex-shrink:0;}
.chat-input-bar input{flex:1;padding:10px 14px;border:1px solid #ddd;border-radius:24px;outline:none;font-size:0.88rem;font-family:inherit;}
.chat-input-bar input:focus{border-color:var(--hover);}
.emoji-btn{background:none;border:none;cursor:pointer;font-size:1.3rem;padding:4px;border-radius:6px;transition:0.15s;flex-shrink:0;}
.emoji-btn:hover{background:var(--light);}
.chat-send-btn{padding:10px 18px;background:var(--main);color:white;border:none;border-radius:24px;cursor:pointer;font-weight:500;font-size:0.85rem;flex-shrink:0;}
/* Emoji é¸å–® */
.emoji-picker{position:absolute;bottom:70px;left:16px;background:white;border-radius:10px;box-shadow:0 4px 20px rgba(63,86,97,0.18);padding:10px;display:none;flex-wrap:wrap;gap:4px;width:260px;z-index:200;}
.emoji-picker.show{display:flex;}
.emoji-opt{font-size:1.4rem;cursor:pointer;padding:4px;border-radius:6px;transition:0.15s;border:none;background:none;}
.emoji-opt:hover{background:#f5f5f5;transform:scale(1.2);}
.chat-area{position:relative;display:flex;flex-direction:column;flex:1;overflow:hidden;}

/* â”€â”€ Modal é€šç”¨ â”€â”€ */
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);}
.modal-content{background:#fff;margin:3% auto;padding:22px;width:90%;max-width:520px;border-radius:10px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 32px rgba(63,86,97,0.15);}
.modal-content h2{margin-top:0;font-size:1.05rem;}
.form-group{margin-bottom:14px;}
.form-group label{display:block;font-size:0.82rem;font-weight:bold;color:#555;margin-bottom:5px;}
.form-group input,.form-group select{width:100%;padding:9px 12px;border:1px solid #ddd;border-radius:8px;font-size:0.88rem;font-family:inherit;outline:none;transition:border-color 0.2s;}
.form-group input:focus,.form-group select:focus{border-color:var(--hover);}
.form-row{display:flex;gap:10px;}
.form-row .form-group{flex:1;}
.region-wrap{display:flex;gap:8px;align-items:flex-start;}
.region-wrap select{flex:1;}
.toggle-region-btn{padding:9px 10px;background:#f0f2f5;border:1px solid #ddd;border-radius:8px;cursor:pointer;font-size:0.78rem;white-space:nowrap;flex-shrink:0;}
.submit-btn{width:100%;padding:11px;background:var(--main);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:0.95rem;margin-top:4px;}
.submit-btn:hover{background:var(--hover);}
.submit-btn:disabled{background:#95a5a6;cursor:not-allowed;}
.close-btn{width:100%;margin-top:10px;padding:9px;border:none;background:var(--light);cursor:pointer;border-radius:5px;}
/* ç•™è¨€ */
.comment-item{background:#f0f4f6;padding:10px 12px;border-radius:8px;margin-bottom:8px;font-size:0.85rem;}
.comment-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;flex-wrap:wrap;gap:4px;}
.comment-user{font-weight:600;color:var(--main);}
.comment-time{font-size:0.72rem;color:#95a5a6;}
.del-comment-btn{background:none;border:none;cursor:pointer;color:#e74c3c;font-size:0.75rem;padding:0;}
.comment-body{word-break:break-word;}
.comment-footer{display:flex;align-items:center;gap:8px;margin-top:6px;}
.like-btn-c{background:none;border:1px solid #ddd;border-radius:20px;padding:2px 10px;cursor:pointer;font-size:0.78rem;transition:0.2s;}
.like-btn-c:hover{background:var(--light);border-color:var(--hover);}
.like-btn-c.liked{background:var(--light);border-color:var(--hover);color:var(--main);}
.comment-item img{max-width:100%;border-radius:6px;margin-top:6px;cursor:pointer;display:block;}
.comment-item iframe{width:100%;height:195px;border:none;border-radius:6px;margin-top:6px;display:block;}
.drive-preview-link{display:flex;align-items:center;gap:8px;background:#e8f5e9;padding:7px 10px;border-radius:6px;margin-top:6px;text-decoration:none;color:#27ae60;font-size:0.8rem;}
.input-hint{font-size:0.72rem;color:#95a5a6;margin-bottom:5px;}
.input-row{display:flex;gap:8px;}
.input-row input{flex:1;padding:9px;border:1px solid #ddd;border-radius:5px;outline:none;font-size:0.88rem;}
.input-row button{padding:9px 16px;background:var(--main);color:white;border:none;border-radius:5px;cursor:pointer;}

/* â”€â”€ æ¸¬é©— â”€â”€ */
#quizModal .modal-content{max-width:540px;}
.quiz-region-list{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px;}
.quiz-region-chip{padding:6px 14px;border:1px solid #ddd;border-radius:20px;cursor:pointer;font-size:0.82rem;transition:0.2s;background:white;}
.quiz-region-chip:hover{border-color:var(--hover);}
.quiz-region-chip.selected{background:var(--main);color:white;border-color:var(--main);}
.quiz-progress{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;font-size:0.85rem;color:#666;}
.quiz-progress-bar{height:5px;background:#eee;border-radius:3px;margin-bottom:16px;overflow:hidden;}
.quiz-progress-fill{height:100%;background:var(--teal);transition:width 0.4s;}
.quiz-question{font-size:1.4rem;font-weight:bold;text-align:center;margin:18px 0;color:var(--main);min-height:55px;}
.quiz-type-label{font-size:0.72rem;color:#95a5a6;font-weight:normal;display:block;margin-bottom:4px;}
.quiz-answer-reveal{background:#f0f2f5;padding:10px;border-radius:8px;text-align:center;margin-bottom:10px;font-size:0.9rem;display:none;}
.quiz-btns{display:flex;gap:10px;margin-bottom:8px;}
.quiz-btn-correct{flex:1;padding:11px;background:#4a7c6f;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.92rem;font-weight:bold;}
.quiz-btn-wrong{flex:1;padding:11px;background:#b05555;color:white;border:none;border-radius:8px;cursor:pointer;font-size:0.92rem;font-weight:bold;}
.quiz-exit-btn{width:100%;padding:7px;background:none;border:1px solid #ddd;border-radius:6px;cursor:pointer;color:#666;font-size:0.8rem;margin-top:4px;}
.quiz-result{text-align:center;padding:10px 0;}
.quiz-score{font-size:3rem;font-weight:bold;color:var(--main);margin:10px 0;}
.quiz-score-sub{color:#666;font-size:0.9rem;}
.quiz-result-btns{display:flex;gap:10px;margin-top:18px;}
.quiz-result-btns button{flex:1;padding:11px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}

/* â”€â”€ Toast & Lightbox â”€â”€ */
.toast{position:fixed;bottom:25px;right:25px;z-index:9999;background:#3f5661;color:white;padding:10px 18px;border-radius:8px;font-size:0.88rem;transform:translateY(100px);opacity:0;transition:all 0.3s ease;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.error{background:#b05555;}
.toast.success{background:#4a7c6f;}
.lightbox{display:none;position:fixed;z-index:9998;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.9);align-items:center;justify-content:center;}
.lightbox.show{display:flex;}
.lightbox img{max-width:90%;max-height:90vh;border-radius:8px;}
.lightbox-close{position:absolute;top:20px;right:30px;color:white;font-size:2rem;cursor:pointer;}
</style>
</head>
<body>
<nav>
  <div class="nav-logo">ğŸ¦´ Anatomy Pro</div>
  <button class="nav-btn active" data-panel="cards">ğŸ“š å–®å­—å¡</button>
  <button class="nav-btn" data-panel="announce">ğŸ“¢ å…¬å‘Šå‹•æ…‹</button>
  <button class="nav-btn" data-panel="chat">ğŸ’¬ èŠå¤©å®¤</button>
  <hr class="nav-divider">
  <div class="region-label">ğŸ“ éƒ¨ä½ç¯©é¸</div>
  <ul id="region-list"></ul>
  <hr class="nav-divider">
  <a class="drive-btn" href="https://drive.google.com/drive/folders/15K0Z4mQYISFuY5FuCQBcBwY1mVBTjcrX?usp=sharing" target="_blank">ğŸ“‚ å…±ç”¨ Google Drive</a>
  <p class="drive-hint">ä¸Šå‚³åœ–ç‰‡ï¼å½±ç‰‡å¾Œè¤‡è£½é€£çµè²¼å…¥ç•™è¨€</p>
  <div class="user-box" id="user-info"><p style="margin:0;font-size:0.82rem;">æª¢æŸ¥ç‹€æ…‹ä¸­...</p></div>
</nav>

<main>
  <!-- å–®å­—å¡é¢æ¿ -->
  <div class="panel active" id="panel-cards">
    <div class="top-filter">
      <button class="filter-btn active" data-cat="å…¨éƒ¨">å…¨éƒ¨</button>
      <button class="filter-btn" data-cat="Muscles">è‚Œè‚‰</button>
      <button class="filter-btn" data-cat="Nerves">ç¥ç¶“</button>
      <button class="filter-btn" data-cat="Vessel">è¡€ç®¡</button>
      <button class="filter-btn" data-cat="Other">å…¶ä»–</button>
      <button class="filter-btn bookmark-filter-btn special-btn" data-cat="æ”¶è—" title="æˆ‘çš„æ”¶è—">
        <svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>
      </button>
      <button class="filter-btn bookmark-filter-btn special-btn" data-cat="æ„›å¿ƒ" title="æˆ‘çš„æ„›å¿ƒ">
        <svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
      </button>
      <button class="add-card-btn" id="add-card-btn">ï¼‹ æ–°å¢</button>
      <button class="delete-mode-btn" id="delete-mode-btn" style="display:none;">ğŸ—‘ åˆªé™¤</button>
      <button class="quiz-start-btn" id="quiz-start-btn">ğŸ¯ æ¸¬é©—</button>
    </div>
    <div class="container"><div id="card-grid" class="card-grid"><div class="loading-state"><h2>ğŸ”’ è«‹å…ˆç™»å…¥</h2></div></div></div>
  </div>

  <!-- å…¬å‘Šé¢æ¿ -->
  <div class="panel" id="panel-announce">
    <div class="panel-header">ğŸ“¢ å…¬å‘Šå‹•æ…‹</div>
    <div class="announce-page" id="announce-page"><div class="announce-empty">â³ è«‹å…ˆç™»å…¥</div></div>
  </div>

  <!-- èŠå¤©å®¤é¢æ¿ -->
  <div class="panel" id="panel-chat">
    <div class="panel-header">ğŸ’¬ èŠå¤©å®¤</div>
    <div class="chat-area">
      <div class="chat-messages" id="chat-messages"><div class="announce-empty" style="margin:auto;">â³ è«‹å…ˆç™»å…¥</div></div>
      <div class="reply-bar" id="reply-bar">
        <span>â†© å›å¾©ï¼š</span>
        <span class="reply-bar-text" id="reply-bar-text"></span>
        <button class="reply-cancel" id="reply-cancel">âœ•</button>
      </div>
      <div class="emoji-picker" id="emoji-picker"></div>
      <div class="chat-input-bar" id="chat-input-bar" style="display:none;">
        <button class="emoji-btn" id="emoji-btn">ğŸ˜Š</button>
        <input type="text" id="chat-input" placeholder="è¼¸å…¥è¨Šæ¯... (Enter é€å‡º)">
        <button class="chat-send-btn" id="chat-send-btn">é€å‡º</button>
      </div>
    </div>
  </div>
</main>

<!-- æ–°å¢å–®å­—å¡ Modal -->
<div id="addCardModal" class="modal">
  <div class="modal-content" style="max-width:480px;">
    <h2>â• æ–°å¢å–®å­—å¡</h2>
    <div class="form-row">
      <div class="form-group"><label>è‹±æ–‡åç¨± *</label><input type="text" id="new-en" placeholder="e.g. Flexor carpi radialis"></div>
      <div class="form-group"><label>ä¸­æ–‡ç¿»è­¯ *</label><input type="text" id="new-ch" placeholder="e.g. æ©ˆå´å±ˆè…•è‚Œ"></div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>é¡å‹ *</label>
        <select id="new-type">
          <option value="">è«‹é¸æ“‡</option>
          <option value="Muscles">Muscles è‚Œè‚‰</option>
          <option value="Nerves">Nerves ç¥ç¶“</option>
          <option value="Arteries">Arteries å‹•è„ˆ</option>
          <option value="Veins">Veins éœè„ˆ</option>
          <option value="Other">Other å…¶ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label>éƒ¨ä½ *</label>
        <div class="region-wrap">
          <select id="new-region-sel"><option value="">è¼‰å…¥ä¸­...</option></select>
          <button class="toggle-region-btn" id="toggle-region-btn">ï¼‹ æ–°éƒ¨ä½</button>
        </div>
        <input type="text" id="new-region-input" placeholder="è¼¸å…¥æ–°éƒ¨ä½åç¨±..." style="display:none;margin-top:6px;width:100%;padding:9px 12px;border:1px solid #ddd;border-radius:8px;font-size:0.88rem;font-family:inherit;outline:none;">
      </div>
    </div>
    <button class="submit-btn" id="submit-card-btn">âœ… æ–°å¢å–®å­—å¡</button>
    <button class="close-btn" id="close-addcard-btn">å–æ¶ˆ</button>
  </div>
</div>

<!-- ç•™è¨€ Modal -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <h2 id="modal-title"></h2>
    <div id="comments-list" style="max-height:300px;overflow-y:auto;margin:10px 0;"></div>
    <div class="input-hint">ğŸ’¡ å¯è²¼å…¥æ–‡å­—ã€Google Drive é€£çµã€YouTube é€£çµ</div>
    <div class="input-row"><input type="text" id="comment-input" placeholder="æ–°å¢ç­†è¨˜æˆ–è²¼å…¥é€£çµ..."><button id="send-btn">é€å‡º</button></div>
    <button class="close-btn" id="close-modal-btn">é—œé–‰</button>
  </div>
</div>

<!-- æ¸¬é©— Modal -->
<div id="quizModal" class="modal"><div class="modal-content"><div id="quiz-body"></div></div></div>

<div class="lightbox" id="lightbox"><span class="lightbox-close" id="lightbox-close">âœ•</span><img id="lightbox-img" src="" alt=""></div>
<div id="toast" class="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import{getFirestore,collection,onSnapshot,doc,updateDoc,arrayUnion,arrayRemove,addDoc,query,orderBy,setDoc,getDoc,deleteDoc,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import{getAuth,signInWithPopup,GoogleAuthProvider,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const ADMIN_UID='XMxcwjPrj7VlcpNBrStyGKPAvL03';
const cfg={apiKey:"AIzaSyB43JZQ7qXrcU_WkVHGEPeZdmicXcmjbq0",authDomain:"anatomy-dc089.firebaseapp.com",projectId:"anatomy-dc089",storageBucket:"anatomy-dc089.firebasestorage.app",messagingSenderId:"742909907454",appId:"1:742909907454:web:5afaaf70fc1b41247270af"};
const app=initializeApp(cfg),db=getFirestore(app),auth=getAuth(),prov=new GoogleAuthProvider();
let allData=[],currentFilter='å…¨éƒ¨',currentRegion=null,currentUser=null,activeCardId=null,myBookmarks=new Set(),chatLoaded=false,allRegions=[],deleteModeOn=false,replyTo=null;

// SVG icons
const SVG_HEART=`<svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;
const SVG_COMMENT=`<svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>`;
const SVG_BOOKMARK=`<svg viewBox="0 0 24 24"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"/></svg>`;

const EMOJIS=['ğŸ˜Š','ğŸ˜‚','â¤ï¸','ğŸ‘','ğŸ”¥','ğŸ’¯','ğŸ˜','ğŸ¥³','ğŸ˜…','ğŸ¤”','ğŸ‘','ğŸ’ª','ğŸ“š','âœ…','âŒ','ğŸ™','ğŸ˜­','ğŸ¤£','ğŸ˜®','ğŸ‰'];

function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className=`toast ${type} show`;setTimeout(()=>{t.className='toast';},3000);}
function fmtTime(ts){if(!ts)return'';const d=ts.toDate?ts.toDate():new Date(ts),p=n=>String(n).padStart(2,'0');return`${d.getMonth()+1}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}
function fmtChat(ts){if(!ts)return'';const d=ts.toDate?ts.toDate():new Date(ts),p=n=>String(n).padStart(2,'0'),today=new Date();return d.toDateString()===today.toDateString()?`${p(d.getHours())}:${p(d.getMinutes())}`:`${d.getMonth()+1}/${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}
function detectLink(t){if(!t)return'text';if(/youtube\.com\/watch|youtu\.be\//.test(t))return'youtube';if(/drive\.google\.com/.test(t))return'drive';if(/\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(t))return'image';if(/^https?:\/\//.test(t))return'link';return'text';}
function ytEmbed(u){const m=u.match(/(?:v=|youtu\.be\/)([^&?/]+)/);return m?`https://www.youtube.com/embed/${m[1]}`:null;}
function driveEmbed(u){const m=u.match(/\/d\/([a-zA-Z0-9_-]+)/)||u.match(/id=([a-zA-Z0-9_-]+)/);return m?`https://drive.google.com/file/d/${m[1]}/preview`:null;}
function renderContent(text){
  const type=detectLink(text);
  if(type==='youtube'){const e=ytEmbed(text);return e?`<div class="comment-body"><iframe src="${e}" allowfullscreen></iframe></div>`:`<div class="comment-body"><a href="${text}" target="_blank">${text}</a></div>`;}
  if(type==='drive'){const e=driveEmbed(text);return e?`<div class="comment-body"><iframe src="${e}" allowfullscreen></iframe></div>`:`<div class="comment-body"><a class="drive-preview-link" href="${text}" target="_blank">ğŸ“ é–‹å•Ÿ</a></div>`;}
  if(type==='image')return`<div class="comment-body"><img src="${text}" onclick="window.openLightbox('${text}')"></div>`;
  if(type==='link')return`<div class="comment-body"><a href="${text}" target="_blank">${text}</a></div>`;
  return`<div class="comment-body">${text}</div>`;
}
window.openLightbox=src=>{document.getElementById('lightbox-img').src=src;document.getElementById('lightbox').classList.add('show');};
document.getElementById('lightbox-close').onclick=()=>document.getElementById('lightbox').classList.remove('show');
document.getElementById('lightbox').onclick=e=>{if(e.target.id==='lightbox')document.getElementById('lightbox').classList.remove('show');};

// â”€â”€ é¢æ¿åˆ‡æ› â”€â”€
function switchPanel(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn[data-panel]').forEach(b=>b.classList.remove('active'));
  document.getElementById(`panel-${name}`).classList.add('active');
  document.querySelector(`.nav-btn[data-panel="${name}"]`).classList.add('active');
  if(name==='chat'&&!chatLoaded&&currentUser){loadChat();chatLoaded=true;}
  if(name==='chat')setTimeout(()=>{const c=document.getElementById('chat-messages');c.scrollTop=c.scrollHeight;},100);
}
document.querySelectorAll('.nav-btn[data-panel]').forEach(b=>b.onclick=()=>switchPanel(b.getAttribute('data-panel')));

// â”€â”€ ç™»å…¥ â”€â”€
onAuthStateChanged(auth,async user=>{
  const box=document.getElementById('user-info');
  if(user){
    currentUser=user;
    box.innerHTML=`<img src="${user.photoURL}" style="width:30px;border-radius:50%;border:2px solid white;"><br><small style="font-size:0.76rem;">${user.displayName}</small><br><button id="logout-btn" style="margin-top:4px;cursor:pointer;padding:2px 8px;border-radius:4px;font-size:0.76rem;">ç™»å‡º</button>`;
    document.getElementById('logout-btn').onclick=()=>signOut(auth);
    document.getElementById('chat-input-bar').style.display='flex';
    if(user.uid===ADMIN_UID)document.getElementById('delete-mode-btn').style.display='block';
    await loadBookmarks();
    loadData();loadRegions();loadAnnouncements();loadChat();chatLoaded=true;
  } else {
    currentUser=null;myBookmarks.clear();chatLoaded=false;deleteModeOn=false;
    box.innerHTML=`<button id="login-btn" style="width:100%;padding:8px;cursor:pointer;border-radius:5px;font-size:0.82rem;">ğŸ”‘ Google ç™»å…¥</button>`;
    document.getElementById('login-btn').onclick=()=>signInWithPopup(auth,prov).catch(()=>showToast('ç™»å…¥å¤±æ•—','error'));
    document.getElementById('card-grid').innerHTML=`<div class="loading-state"><h2>ğŸ”’ è«‹å…ˆç™»å…¥</h2></div>`;
    document.getElementById('chat-input-bar').style.display='none';
    document.getElementById('delete-mode-btn').style.display='none';
  }
});

// â”€â”€ åˆªé™¤æ¨¡å¼ï¼ˆç®¡ç†å“¡ï¼‰ â”€â”€
document.getElementById('delete-mode-btn').onclick=()=>{
  deleteModeOn=!deleteModeOn;
  document.getElementById('delete-mode-btn').classList.toggle('active',deleteModeOn);
  document.getElementById('card-grid').classList.toggle('delete-mode-active',deleteModeOn);
  showToast(deleteModeOn?'ğŸ—‘ åˆªé™¤æ¨¡å¼é–‹å•Ÿï¼Œé» âœ• åˆªé™¤å¡ç‰‡':'åˆªé™¤æ¨¡å¼å·²é—œé–‰',deleteModeOn?'error':'');
};

// â”€â”€ æ›¸ç±¤ â”€â”€
async function loadBookmarks(){try{const s=await getDoc(doc(db,'bookmarks',currentUser.uid));myBookmarks=new Set(s.exists()?(s.data().cards||[]):[]);}catch(e){myBookmarks=new Set();}}
async function toggleBookmark(id){
  if(!currentUser)return;
  const had=myBookmarks.has(id);had?myBookmarks.delete(id):myBookmarks.add(id);
  try{await setDoc(doc(db,'bookmarks',currentUser.uid),{cards:[...myBookmarks]});render();showToast(had?'å·²å¾æ”¶è—ç§»é™¤':'å·²åŠ å…¥æ”¶è— ğŸ”–',had?'':'success');}
  catch(e){console.error(e);}
}

// â”€â”€ éƒ¨ä½ â”€â”€
const DEFAULT_REGIONS=[
  {id:'1',name:'1. èƒŒéƒ¨èˆ‡é ¸å¾Œå€',order:1},{id:'2',name:'2. èƒ¸éƒ¨èˆ‡è…‹çª©å€',order:2},
  {id:'3',name:'3. è‚©èƒ›ã€è‡‚éƒ¨èˆ‡è‚˜å€',order:3},{id:'4',name:'4. å‰è‡‚å€',order:4},{id:'5',name:'5. æ‰‹éƒ¨',order:5}
];
function loadRegions(){
  onSnapshot(collection(db,'regions'),snap=>{
    const fsR=snap.docs.map(d=>({id:d.id,...d.data()}));
    const fsIds=new Set(fsR.map(r=>r.id));
    allRegions=[...DEFAULT_REGIONS.filter(d=>!fsIds.has(d.id)),...fsR].sort((a,b)=>(a.order||0)-(b.order||0));
    renderRegionList();renderRegionSelect();
  });
}
function renderRegionList(){
  const ul=document.getElementById('region-list');
  ul.innerHTML=allRegions.map(r=>`<li data-region="${r.id}">${r.name}</li>`).join('');
  ul.querySelectorAll('li').forEach(li=>li.onclick=()=>{
    const r=li.getAttribute('data-region');
    if(currentRegion===r){currentRegion=null;ul.querySelectorAll('li').forEach(l=>l.classList.remove('active-region'));}
    else{currentRegion=r;ul.querySelectorAll('li').forEach(l=>l.classList.remove('active-region'));li.classList.add('active-region');}
    render();
  });
}
function renderRegionSelect(){
  const sel=document.getElementById('new-region-sel');if(!sel)return;
  sel.innerHTML='<option value="">è«‹é¸æ“‡éƒ¨ä½</option>'+allRegions.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
}

// â”€â”€ æ–°å¢å–®å­—å¡ â”€â”€
let isNewRegion=false;
document.getElementById('add-card-btn').onclick=()=>{
  if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}
  ['new-en','new-ch'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('new-type').value='';
  document.getElementById('new-region-sel').value='';
  document.getElementById('new-region-input').value='';
  document.getElementById('new-region-input').style.display='none';
  document.getElementById('new-region-sel').style.display='block';
  document.getElementById('toggle-region-btn').textContent='ï¼‹ æ–°éƒ¨ä½';
  isNewRegion=false;
  document.getElementById('addCardModal').style.display='block';
};
document.getElementById('toggle-region-btn').onclick=()=>{
  isNewRegion=!isNewRegion;
  document.getElementById('new-region-input').style.display=isNewRegion?'block':'none';
  document.getElementById('new-region-sel').style.display=isNewRegion?'none':'block';
  document.getElementById('toggle-region-btn').textContent=isNewRegion?'â† é¸ç¾æœ‰':'ï¼‹ æ–°éƒ¨ä½';
  if(isNewRegion)document.getElementById('new-region-input').focus();
};
document.getElementById('submit-card-btn').onclick=async()=>{
  const en=document.getElementById('new-en').value.trim(),ch=document.getElementById('new-ch').value.trim(),type=document.getElementById('new-type').value;
  if(!en||!ch||!type){showToast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½','error');return;}
  let regionId,regionName;
  if(isNewRegion){
    regionName=document.getElementById('new-region-input').value.trim();
    if(!regionName){showToast('è«‹è¼¸å…¥æ–°éƒ¨ä½åç¨±','error');return;}
    try{const ref=await addDoc(collection(db,'regions'),{name:regionName,order:allRegions.length+1});regionId=ref.id;}
    catch(e){showToast('æ–°å¢éƒ¨ä½å¤±æ•—','error');return;}
  } else {
    regionId=document.getElementById('new-region-sel').value;
    if(!regionId){showToast('è«‹é¸æ“‡éƒ¨ä½','error');return;}
    regionName=allRegions.find(r=>r.id===regionId)?.name||regionId;
  }
  const btn=document.getElementById('submit-card-btn');
  btn.disabled=true;btn.textContent='æ–°å¢ä¸­...';
  try{
    const cardRef=await addDoc(collection(db,'flashcards'),{en,ch,type,region:regionId,comments:[],likes:[],createdBy:currentUser.displayName,createdByUid:currentUser.uid,createdAt:new Date().toISOString()});
    await addDoc(collection(db,'announcements'),{user:currentUser.displayName,action:'æ–°å¢',cardEn:en,cardId:cardRef.id,contentType:'å–®å­—å¡',regionName,time:new Date()});
    document.getElementById('addCardModal').style.display='none';
    showToast(`ã€Œ${en}ã€å·²æ–°å¢ï¼`,'success');
    isNewRegion=false;
  }catch(e){console.error(e);showToast('æ–°å¢å¤±æ•—','error');}
  finally{btn.disabled=false;btn.textContent='âœ… æ–°å¢å–®å­—å¡';}
};
document.getElementById('close-addcard-btn').onclick=()=>document.getElementById('addCardModal').style.display='none';
document.getElementById('addCardModal').addEventListener('click',e=>{if(e.target.id==='addCardModal')document.getElementById('addCardModal').style.display='none';});

// â”€â”€ å…¬å‘Š â”€â”€
function loadAnnouncements(){
  onSnapshot(query(collection(db,'announcements'),orderBy('time','desc')),snap=>{
    const page=document.getElementById('announce-page');
    if(snap.empty){page.innerHTML='<div class="announce-empty">ğŸ“­ ç›®å‰æš«ç„¡å‹•æ…‹</div>';return;}
    page.innerHTML=snap.docs.map(d=>{
      const a=d.data();let icon,desc,cardId=a.cardId||'';
      if(a.contentType==='å–®å­—å¡'){icon='ğŸƒ';desc=`<b>${a.user}</b> æ–°å¢äº†å–®å­—å¡ <span class="ac-card-name">${a.cardEn}</span>ï¼ˆ${a.regionName||''}ï¼‰`;}
      else if(a.contentType==='åª’é«”'){icon='ğŸ–¼ï¸';desc=`<b>${a.user}</b> åœ¨ <span class="ac-card-name">${a.cardEn}</span> æ–°å¢äº†${a.action==='åˆªé™¤'?'ä¸¦åˆªé™¤äº†':''}åª’é«”`;}
      else{icon='ğŸ“';desc=`<b>${a.user}</b> ${a.action==='åˆªé™¤'?'åˆªé™¤äº†':'æ–°å¢äº†'}ç­†è¨˜åœ¨ <span class="ac-card-name">${a.cardEn}</span>`;}
      const clickable=!!cardId;
      return`<div class="announce-card ${clickable?'clickable':''}" ${clickable?`onclick="window.jumpToCard('${cardId}')"`:''}><div class="ac-icon">${icon}</div><div class="ac-body"><div class="ac-main">${desc}</div><div class="ac-time">${fmtTime(a.time)}</div></div>${clickable?`<button class="ac-goto" onclick="event.stopPropagation();window.jumpToCard('${cardId}')">å‰å¾€</button>`:''}</div>`;
    }).join('');
  });
}
window.jumpToCard=cardId=>{
  switchPanel('cards');currentFilter='å…¨éƒ¨';currentRegion=null;
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  document.querySelector('.filter-btn[data-cat="å…¨éƒ¨"]').classList.add('active');
  document.querySelectorAll('#region-list li').forEach(l=>l.classList.remove('active-region'));
  render();
  setTimeout(()=>{
    const el=document.getElementById(`card-${cardId}`);
    if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='3px solid var(--teal)';setTimeout(()=>el.style.outline='',2000);}
    window.openNotes(cardId);
  },150);
};

// â”€â”€ èŠå¤©å®¤ â”€â”€
// Emoji picker
const picker=document.getElementById('emoji-picker');
EMOJIS.forEach(em=>{
  const btn=document.createElement('button');btn.className='emoji-opt';btn.textContent=em;
  btn.onclick=()=>{document.getElementById('chat-input').value+=em;picker.classList.remove('show');document.getElementById('chat-input').focus();};
  picker.appendChild(btn);
});
document.getElementById('emoji-btn').onclick=e=>{e.stopPropagation();picker.classList.toggle('show');};
document.addEventListener('click',()=>picker.classList.remove('show'));

// å›å¾©åŠŸèƒ½
document.getElementById('reply-cancel').onclick=()=>{replyTo=null;document.getElementById('reply-bar').classList.remove('show');};

function loadChat(){
  onSnapshot(query(collection(db,'chatMessages'),orderBy('time','asc')),snap=>{
    const c=document.getElementById('chat-messages');
    if(snap.empty){c.innerHTML='<div class="announce-empty" style="margin:auto;">ğŸ‘‹ ä¾†æ‰“å€‹æ‹›å‘¼å§ï¼</div>';return;}
    let lastDate='';
    c.innerHTML=snap.docs.map(d=>{
      const m=d.data(),isMe=currentUser&&m.userId===currentUser.uid;
      const msgDate=m.time?(m.time.toDate?m.time.toDate():new Date(m.time)).toDateString():'';
      let divider='';
      if(msgDate&&msgDate!==lastDate){
        lastDate=msgDate;const dObj=m.time.toDate?m.time.toDate():new Date(m.time);
        divider=`<div class="chat-date-divider">â”€â”€ ${dObj.getFullYear()}/${dObj.getMonth()+1}/${dObj.getDate()} â”€â”€</div>`;
      }
      const replyHtml=m.replyTo?`<div class="reply-preview">â†© ${m.replyTo.user}ï¼š${m.replyTo.text.slice(0,40)}${m.replyTo.text.length>40?'...':''}</div>`:'';
      return`${divider}<div class="chat-msg ${isMe?'me':''}" data-id="${d.id}" data-user="${m.user}" data-text="${(m.text||'').replace(/"/g,'&quot;')}">
        <div class="avatar">${m.photoURL?`<img src="${m.photoURL}" alt="">`:m.user.charAt(0)}</div>
        <div class="chat-bubble" onclick="window.setReply('${d.id}','${m.user.replace(/'/g,"\\'")}','${(m.text||'').replace(/'/g,"\\'").replace(/\n/g,' ')}')">
          ${!isMe?`<div class="cb-name">${m.user}</div>`:''}
          ${replyHtml}
          <div class="cb-text">${m.text}</div>
          <div class="cb-time">${fmtChat(m.time)}</div>
        </div>
      </div>`;
    }).join('');
    setTimeout(()=>{c.scrollTop=c.scrollHeight;},50);
  });
}

window.setReply=(id,user,text)=>{
  replyTo={id,user,text};
  document.getElementById('reply-bar-text').textContent=`${user}ï¼š${text}`;
  document.getElementById('reply-bar').classList.add('show');
  document.getElementById('chat-input').focus();
};

async function sendChat(){
  const inp=document.getElementById('chat-input'),text=inp.value.trim();
  if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}if(!text)return;
  const msg={user:currentUser.displayName,userId:currentUser.uid,photoURL:currentUser.photoURL||'',text,time:serverTimestamp()};
  if(replyTo)msg.replyTo={id:replyTo.id,user:replyTo.user,text:replyTo.text};
  inp.value='';replyTo=null;
  document.getElementById('reply-bar').classList.remove('show');
  try{await addDoc(collection(db,'chatMessages'),msg);}
  catch(e){console.error(e);showToast('é€å‡ºå¤±æ•—','error');}
}
document.getElementById('chat-send-btn').onclick=sendChat;
document.getElementById('chat-input').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey)sendChat();});

// â”€â”€ è³‡æ–™ â”€â”€
function loadData(){
  document.getElementById('card-grid').innerHTML=`<div class="loading-state"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div>`;
  onSnapshot(collection(db,'flashcards'),snap=>{
    allData=snap.docs.map(d=>({id:d.id,...d.data()}));
    render();
    const modal=document.getElementById('commentModal');
    if(modal.style.display==='block'&&activeCardId){const u=allData.find(d=>d.id===activeCardId);if(u)renderComments(u);}
  },err=>{console.error(err);showToast('è³‡æ–™è¼‰å…¥å¤±æ•—','error');});
}
function getColor(type){const t=(type||'').toLowerCase();if(t.includes('arteries')||t.includes('veins'))return'var(--vessel)';if(t.includes('muscle'))return'var(--muscle)';if(t.includes('nerve'))return'var(--nerve)';return'var(--other)';}

window.adminDeleteCard=async(cardId,en)=>{
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${en}ã€å—ï¼Ÿ`))return;
  try{await deleteDoc(doc(db,'flashcards',cardId));showToast(`ã€Œ${en}ã€å·²åˆªé™¤`,'success');}
  catch(e){console.error(e);showToast('åˆªé™¤å¤±æ•—','error');}
};

function buildCard(data){
  const wrap=document.createElement('div');wrap.id=`card-${data.id}`;
  const color=getColor(data.type),isSaved=myBookmarks.has(data.id),likes=data.likes||[],iLiked=currentUser&&likes.includes(currentUser.uid),commentCount=(data.comments||[]).length;
  wrap.innerHTML=`<div class="ig-card" style="--card-color:${color}">
    <button class="admin-del-btn" onclick="window.adminDeleteCard('${data.id}','${(data.en||'').replace(/'/g,"\\'")}')">âœ•</button>
    <div class="ig-card-flip" onclick="this.querySelector('.ig-card-inner').classList.toggle('flipped')">
      <div class="ig-card-inner">
        <div class="ig-face ig-front">
          <span class="ig-badge" style="background:${color};color:white;">${data.type||'Other'}</span>
          <h3>${data.en||''}</h3>
          <div class="ig-sub">é»æ“ŠæŸ¥çœ‹ä¸­æ–‡</div>
        </div>
        <div class="ig-face ig-back">
          <span class="ig-badge" style="background:rgba(255,255,255,0.18);color:white;">${data.type||'Other'}</span>
          <h3>${data.ch||''}</h3>
          <div class="ig-sub">é»æ“Šç­†è¨˜ç•™è¨€ â†“</div>
        </div>
      </div>
    </div>
    <div class="ig-actions">
      <button class="ig-act-btn heart-btn ${iLiked?'heart-active':''}">${SVG_HEART}<span class="ig-count">${likes.length||''}</span></button>
      <button class="ig-act-btn comment-btn">${SVG_COMMENT}<span class="ig-count">${commentCount||''}</span></button>
      <div class="ig-spacer"></div>
      <button class="ig-act-btn bookmark-btn ${isSaved?'saved-active':''}">${SVG_BOOKMARK}</button>
    </div>
  </div>`;
  wrap.querySelector('.heart-btn').onclick=async e=>{
    e.stopPropagation();if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}
    const card=allData.find(d=>d.id===data.id),cur=card.likes||[],already=cur.includes(currentUser.uid);
    try{await updateDoc(doc(db,'flashcards',data.id),{likes:already?arrayRemove(currentUser.uid):arrayUnion(currentUser.uid)});}catch(e){console.error(e);}
  };
  wrap.querySelector('.comment-btn').onclick=e=>{e.stopPropagation();window.openNotes(data.id);};
  wrap.querySelector('.bookmark-btn').onclick=e=>{e.stopPropagation();toggleBookmark(data.id);};
  return wrap;
}

function render(){
  const grid=document.getElementById('card-grid');grid.innerHTML='';
  if(deleteModeOn)grid.classList.add('delete-mode-active');else grid.classList.remove('delete-mode-active');
  const filtered=allData.filter(d=>{
    if(currentFilter==='æ”¶è—')return myBookmarks.has(d.id);
    if(currentFilter==='æ„›å¿ƒ')return currentUser&&(d.likes||[]).includes(currentUser.uid);
    if(currentRegion!==null&&String(d.region)!==String(currentRegion))return false;
    if(currentFilter==='å…¨éƒ¨')return true;
    if(currentFilter==='Vessel')return(d.type||'').toLowerCase().includes('arteries')||(d.type||'').toLowerCase().includes('veins');
    return(d.type||'').toLowerCase()===currentFilter.toLowerCase();
  });
  if(filtered.length===0){const msg=currentFilter==='æ”¶è—'?'é‚„æ²’æœ‰æ”¶è—çš„å–®å­—å¡':currentFilter==='æ„›å¿ƒ'?'é‚„æ²’æœ‰æŒ‰éæ„›å¿ƒçš„å–®å­—å¡':'æ­¤åˆ†é¡ç›®å‰æ²’æœ‰è³‡æ–™';grid.innerHTML=`<div class="empty-state"><p style="font-size:2rem;">${currentFilter==='æ”¶è—'?'ğŸ”–':currentFilter==='æ„›å¿ƒ'?'â¤ï¸':'ğŸ”'}</p><p>${msg}</p></div>`;return;}
  filtered.forEach(d=>grid.appendChild(buildCard(d)));
}

document.querySelectorAll('.filter-btn').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');currentFilter=btn.getAttribute('data-cat');render();
});

// â”€â”€ ç•™è¨€ Modal â”€â”€
window.openNotes=id=>{
  activeCardId=id;const data=allData.find(d=>d.id===id);if(!data)return;
  document.getElementById('modal-title').innerText=`${data.en} (${data.ch})`;
  renderComments(data);document.getElementById('commentModal').style.display='block';
};
function renderComments(data){
  const list=document.getElementById('comments-list');
  if(!data.comments||data.comments.length===0){list.innerHTML='<p style="color:#95a5a6;text-align:center;padding:10px;">å°šç„¡ç­†è¨˜</p>';return;}
  list.innerHTML=data.comments.map((c,idx)=>{
    const isOwner=currentUser&&c.user===currentUser.displayName,likes=c.likes||[],iLiked=currentUser&&likes.includes(currentUser.displayName),timeStr=c.time?fmtTime({toDate:()=>new Date(c.time)}):'';
    return`<div class="comment-item"><div class="comment-header"><span class="comment-user">${c.user}</span><span style="display:flex;align-items:center;gap:6px;"><span class="comment-time">${timeStr}</span><button class="like-btn-c ${iLiked?'liked':''}" data-idx="${idx}" style="display:flex;align-items:center;gap:3px;padding:2px 8px;"><svg viewBox="0 0 24 24" style="width:13px;height:13px;fill:${iLiked?'#e74c3c':'none'};stroke:${iLiked?'#e74c3c':'currentColor'};stroke-width:2;stroke-linecap:round;stroke-linejoin:round;"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>${likes.length||''}</button>${isOwner?`<button class="del-comment-btn" data-idx="${idx}">åˆªé™¤</button>`:''}</span></div>${renderContent(c.text)}</div>`;
  }).join('');
  list.querySelectorAll('.like-btn-c').forEach(btn=>btn.onclick=async()=>{
    if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}
    const idx=parseInt(btn.getAttribute('data-idx')),cardData=allData.find(d=>d.id===activeCardId),c=cardData.comments[idx],likes=c.likes||[],iLiked=likes.includes(currentUser.displayName);
    const nc={...c,likes:iLiked?likes.filter(l=>l!==currentUser.displayName):[...likes,currentUser.displayName]};
    const ncs=[...cardData.comments];ncs[idx]=nc;
    try{await updateDoc(doc(db,'flashcards',activeCardId),{comments:ncs});}catch(e){console.error(e);}
  });
  list.querySelectorAll('.del-comment-btn').forEach(btn=>btn.onclick=async()=>{
    const idx=parseInt(btn.getAttribute('data-idx')),cardData=allData.find(d=>d.id===activeCardId),cr=cardData.comments[idx],ct=detectLink(cr.text)==='text'?'ç­†è¨˜':'åª’é«”';
    try{
      await updateDoc(doc(db,'flashcards',activeCardId),{comments:arrayRemove(cr)});
      await addDoc(collection(db,'announcements'),{user:currentUser.displayName,action:'åˆªé™¤',cardEn:cardData.en,cardId:activeCardId,contentType:ct,time:new Date()});
      showToast('å·²åˆªé™¤','success');
    }catch(e){console.error(e);}
  });
}
document.getElementById('send-btn').onclick=async()=>{
  const inp=document.getElementById('comment-input'),text=inp.value.trim();
  if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}if(!text){showToast('è«‹è¼¸å…¥å…§å®¹','error');return;}
  const cardData=allData.find(d=>d.id===activeCardId),ct=detectLink(text)==='text'?'ç­†è¨˜':'åª’é«”';
  try{
    await updateDoc(doc(db,'flashcards',activeCardId),{comments:arrayUnion({user:currentUser.displayName,text,time:new Date().toISOString(),likes:[]})});
    await addDoc(collection(db,'announcements'),{user:currentUser.displayName,action:'æ–°å¢',cardEn:cardData.en,cardId:activeCardId,contentType:ct,time:new Date()});
    inp.value='';showToast('å·²å„²å­˜','success');
  }catch(e){console.error(e);showToast('å„²å­˜å¤±æ•—','error');}
};
document.getElementById('comment-input').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('send-btn').click();});
document.getElementById('close-modal-btn').onclick=()=>document.getElementById('commentModal').style.display='none';
document.getElementById('commentModal').addEventListener('click',e=>{if(e.target.id==='commentModal')document.getElementById('commentModal').style.display='none';});

// â”€â”€ æ¸¬é©— â”€â”€
const QUIZ_TOTAL=30;
document.getElementById('quiz-start-btn').onclick=()=>{
  if(!currentUser){showToast('è«‹å…ˆç™»å…¥','error');return;}if(allData.length===0){showToast('å–®å­—å¡è¼‰å…¥ä¸­','error');return;}
  showQuizSetup();document.getElementById('quizModal').style.display='block';
};
function showQuizSetup(){
  document.getElementById('quiz-body').innerHTML=`
    <h3 style="margin-top:0;">ğŸ¯ æ¸¬é©—è¨­å®š</h3>
    <p style="font-size:0.85rem;color:#666;margin-bottom:6px;">é¸æ“‡è¦è€ƒçš„éƒ¨ä½ï¼ˆå¯è¤‡é¸ï¼Œä¸é¸å‰‡è€ƒå…¨éƒ¨ï¼‰</p>
    <div class="quiz-region-list" id="quiz-region-chips">
      ${allRegions.map(r=>`<div class="quiz-region-chip" data-rid="${r.id}">${r.name}</div>`).join('')}
    </div>
    <button class="submit-btn" id="quiz-go-btn">é–‹å§‹æ¸¬é©—</button>
    <button class="quiz-exit-btn" onclick="document.getElementById('quizModal').style.display='none'">å–æ¶ˆ</button>
  `;
  document.querySelectorAll('.quiz-region-chip').forEach(chip=>chip.onclick=()=>chip.classList.toggle('selected'));
  document.getElementById('quiz-go-btn').onclick=()=>{
    const selected=[...document.querySelectorAll('.quiz-region-chip.selected')].map(c=>c.getAttribute('data-rid'));
    let pool=selected.length>0?allData.filter(d=>selected.includes(String(d.region))):allData;
    if(pool.length===0){showToast('æ­¤éƒ¨ä½æ²’æœ‰å–®å­—å¡','error');return;}
    const shuffled=[...pool].sort(()=>Math.random()-0.5).slice(0,Math.min(QUIZ_TOTAL,pool.length));
    startQuiz(shuffled);
  };
}
function startQuiz(questions){
  const qs=questions.map(d=>({id:d.id,en:d.en,ch:d.ch}));
  showQuizQ({questions:qs,current:0,correct:0,wrong:0});
}
function showQuizQ(state){
  const q=state.questions[state.current],total=state.questions.length,prog=state.current;
  document.getElementById('quiz-body').innerHTML=`
    <div class="quiz-progress"><span>ç¬¬ ${prog+1} / ${total} é¡Œ</span><span>âœ… ${state.correct} &nbsp; âŒ ${state.wrong}</span></div>
    <div class="quiz-progress-bar"><div class="quiz-progress-fill" style="width:${(prog/total)*100}%"></div></div>
    <div class="quiz-question"><span class="quiz-type-label">çœ‹ä¸­æ–‡çŒœè‹±æ–‡</span>${q.ch}</div>
    <div id="qar" class="quiz-answer-reveal">ç­”æ¡ˆï¼š<b>${q.en}</b></div>
    <button id="qsa" style="width:100%;padding:10px;background:#f0f2f5;border:none;border-radius:8px;cursor:pointer;margin-bottom:10px;font-size:0.88rem;">é¡¯ç¤ºç­”æ¡ˆ</button>
    <div class="quiz-btns" id="qrb" style="display:none;">
      <button class="quiz-btn-correct" id="qc">âœ… ç­”å°äº†</button>
      <button class="quiz-btn-wrong" id="qw">âŒ ç­”éŒ¯äº†</button>
    </div>
    <button class="quiz-exit-btn" id="qe">çµæŸæ¸¬é©—ï¼ˆä¸å„²å­˜é€²åº¦ï¼‰</button>
  `;
  document.getElementById('qsa').onclick=()=>{document.getElementById('qar').style.display='block';document.getElementById('qsa').style.display='none';document.getElementById('qrb').style.display='flex';};
  document.getElementById('qc').onclick=()=>{state.correct++;nextQ(state);};
  document.getElementById('qw').onclick=()=>{state.wrong++;nextQ(state);};
  document.getElementById('qe').onclick=()=>document.getElementById('quizModal').style.display='none';
}
function nextQ(state){state.current++;if(state.current>=state.questions.length)showQuizResult(state);else showQuizQ(state);}
function showQuizResult(state){
  const pct=Math.round((state.correct/state.questions.length)*100);
  document.getElementById('quiz-body').innerHTML=`<div class="quiz-result"><p style="font-size:1.1rem;margin:0;">ğŸ‰ æ¸¬é©—å®Œæˆï¼</p><div class="quiz-score">${state.correct} / ${state.questions.length}</div><div class="quiz-score-sub">æ­£ç¢ºç‡ ${pct}%</div><div style="margin-top:12px;font-size:0.88rem;color:#666;">${pct>=80?'å¤ªæ£’äº†ï¼ğŸ’ª':pct>=60?'ä¸éŒ¯ï¼Œå†åŠ æ²¹ ğŸ“š':'éœ€è¦å¤šè¤‡ç¿’å–” ğŸ˜Š'}</div><div class="quiz-result-btns"><button onclick="window._quizAgain()" style="background:var(--teal);color:white;">å†ä¾†ä¸€æ¬¡</button><button onclick="document.getElementById('quizModal').style.display='none'" style="background:#eee;color:#333;">é—œé–‰</button></div></div>`;
}
window._quizAgain=()=>showQuizSetup();
document.getElementById('quizModal').addEventListener('click',e=>{if(e.target.id==='quizModal')document.getElementById('quizModal').style.display='none';});
</script>
</body>
</html>
